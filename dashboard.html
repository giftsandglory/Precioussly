<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard – Precioussly</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#064c2c;
      --mint:#e9fef1;
      --mint-border:#c5ecd6;
      --ink:#111;
      --muted:#555;
      --card:#fff;
      --ring:#e6e6e6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Roboto Slab',serif;background:#f8f9fb;color:var(--ink)}
    /* Header (kept lightweight so it works standalone) */
    .site-header{position:sticky;top:0;z-index:10;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .right-icon{width:32px;height:32px;border-radius:50%;object-fit:cover}
    #announcementBar{margin:0;padding:6px 10px;font-size:13px;color:#fff;background:#000;text-align:center;user-select:none}
    /* Container */
    .container{max-width:560px;margin:0 auto;padding:20px 14px}
    /* Profile card */
    .profile{background:var(--card);padding:22px 16px;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.08);text-align:center}
    .profile img{width:92px;height:92px;border-radius:50%;object-fit:cover;border:4px solid var(--mint-border);background:var(--mint);padding:3px}
    .profile h2{margin:12px 0 4px;font-size:22px;font-weight:700}
    .profile p{margin:0;color:var(--muted)}
    .btn{display:inline-block;padding:12px 22px;border-radius:12px;font-weight:700;border:1.5px solid #000;background:#fff;color:#000;text-decoration:none;transition:transform .2s, box-shadow .2s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.12)}
    .btn--green{background:var(--mint);border-color:var(--mint-border);color:var(--brand)}
    .btn--pill{border-radius:24px}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
    .logout-wrap{text-align:center;margin-top:18px}
    /* Orders Modal */
    .orders-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .orders-box{width:100%;max-width:400px;background:#fff;border:2px solid #bbb;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.25);padding:14px 14px 16px;max-height:92vh;overflow:auto}
    .orders-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .orders-title{margin:0;font-size:18px;font-weight:700}
    .close-btn{border:1px solid #000;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .empty{ text-align:center; padding:16px; color:#555 }
    .order-card{border:1px solid #eee;border-radius:12px;background:#fff;padding:12px;margin-top:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    .order-row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .badge{display:inline-block;font-size:12px;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;color:#222;background:#fafafa}
    .thumbs{display:flex;gap:6px;margin-top:6px}
    .thumbs img{width:50px;height:50px;border-radius:8px;border:1px solid #eee;object-fit:cover}
    .meta{font-size:13px;color:#444;margin:2px 0}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .track-link{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:10px;border:1.5px solid var(--mint-border);background:var(--mint);color:var(--brand);font-weight:700;text-decoration:none}
    .back-btn{width:100%;margin-top:14px}
    /* Toast */
    .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;box-shadow:0 8px 18px rgba(0,0,0,.25);display:none;z-index:10000}
  </style>
</head>
<body>
  <header class="site-header">
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="https://i.postimg.cc/HnRbjRbh/Best-Logo.png" alt="Logo" style="height:28px;cursor:pointer" onclick="location.href='https://precioussly.com'">
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <img id="profileIcon" class="right-icon" alt="Profile" src="https://i.postimg.cc/1tRZMmmB/Profile-Icon.png" onclick="handleProfileClick()">
      <a href="https://www.precioussly.com/cart" style="position:relative;display:inline-block">
        <img class="right-icon" alt="Cart" src="https://i.postimg.cc/MZF8bJh0/Cart-Icon.png">
        <span id="cartCountBadge" style="position:absolute;top:-6px;right:-6px;background:#fff;color:#000;border:1px solid #777;border-radius:50%;width:19px;height:19px;display:none;align-items:center;justify-content:center;font-size:12px">0</span>
      </a>
    </div>
  </header>

  <div id="announcementBar">Free Delivery | COD Available | Min Order ₹299</div>

  <main class="container">
    <div class="profile">
      <img id="userImage" alt="Profile Photo">
      <h2 id="userName">Hello</h2>
      <p id="userEmail"></p>
      <div class="actions">
        <a class="btn btn--green" href="https://precioussly.com/track-order">Track Order</a>
        <button class="btn btn--green" id="viewOrdersBtn" onclick="openOrdersPopup()">View Orders</button>
      </div>
    </div>
    <div class="logout-wrap">
      <a class="btn btn--pill" href="#" onclick="logout()">Logout</a>
    </div>
  </main>

  <!-- Orders Modal -->
  <div id="ordersOverlay" class="orders-overlay" role="dialog" aria-modal="true" aria-labelledby="ordersTitle">
    <div class="orders-box">
      <div class="orders-head">
        <h3 id="ordersTitle" class="orders-title">Your Orders</h3>
        <button class="close-btn" onclick="closeOrdersPopup()">✕</button>
      </div>
      <div id="ordersList" style="margin-top:10px"></div>
      <button class="btn back-btn" onclick="closeOrdersPopup()">Back</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ========= AUTH + PROFILE ========= */
function handleProfileClick(){
  const isLoggedIn = localStorage.getItem("user_email");
  if(isLoggedIn){ location.href="/dashboard"; }
  else{
    location.href = "https://accounts.google.com/o/oauth2/v2/auth?client_id=746848628668-83a44mlh0klb2kp8gajhi4j26sd33l61.apps.googleusercontent.com&redirect_uri=https://precioussly.com&response_type=token&scope=email%20profile&prompt=consent";
  }
}
const name  = localStorage.getItem("user_name");
const email = localStorage.getItem("user_email");
const photo = localStorage.getItem("user_photo");
if (location.hostname !== "localhost" && (!name || !email || !photo)) {
  location.href = "/";
}
document.getElementById("userName").innerText = `Hello, ${name||""}`;
document.getElementById("userEmail").innerText = email||"";
document.getElementById("userImage").src = photo||"";
document.getElementById("profileIcon").src = photo || "https://i.postimg.cc/1tRZMmmB/Profile-Icon.png";

/* ========= CART BADGE ========= */
function updateCartBadge(){
  const items = JSON.parse(localStorage.getItem("cartItems")||"[]");
  const count = items.reduce((s,it)=>s+(Number(it.qty)||0),0);
  const badge = document.getElementById("cartCountBadge");
  if(count>0){ badge.style.display='flex'; badge.textContent=count; } else { badge.style.display='none'; }
}
updateCartBadge();

/* ========= PERSIST ORDERS PER USER EMAIL =========
   Storage shape:
   localStorage['orders_by_user'] = JSON.stringify({ "email@example.com": [order, ...] })
   We never delete this map on logout; we only remove auth keys.
=================================================== */
function safeParse(json, fallback){
  try{ return JSON.parse(json); }catch(e){ return fallback; }
}
function getOrdersMap(){
  return safeParse(localStorage.getItem("orders_by_user")||"{}", {});
}
function setOrdersMap(map){
  localStorage.setItem("orders_by_user", JSON.stringify(map||{}));
}
function getCurrentEmail(){
  return localStorage.getItem("user_email") || "";
}
/* Public helpers (you can call from other pages too) */
window.saveOrderForCurrentUser = function(order){
  const email = getCurrentEmail();
  if(!email) return;
  const map = getOrdersMap();
  if(!Array.isArray(map[email])) map[email]=[];
  map[email].unshift(order);           // newest first
  setOrdersMap(map);
};
window.getOrdersForEmail = function(email){
  const map = getOrdersMap();
  return Array.isArray(map[email]) ? map[email] : [];
};

/* ========= RENDER ORDERS UI ========= */
function orderTrackUrl(o){
  if (o.trackingUrl) return o.trackingUrl;
  if (o.id) return `https://precioussly.com/track-order?id=${encodeURIComponent(o.id)}`;
  return `https://precioussly.com/track-order`;
}
function formatDate(d){
  try{
    const dt = (d instanceof Date) ? d : new Date(d);
    return dt.toLocaleString('en-IN', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });
  }catch(e){ return d || '-'; }
}
function renderOrders(){
  const list = document.getElementById("ordersList");
  const orders = window.getOrdersForEmail(getCurrentEmail());
  if(!orders.length){
    list.innerHTML = `<div class="empty">
      <img src="https://cdn-icons-png.flaticon.com/512/2331/2331970.png" style="width:72px;opacity:.6" alt="Empty"><br>
      No orders yet.
    </div>`;
    return;
  }
  list.innerHTML = orders.map(o => {
    const itemsLine = (o.items||[]).map(it => `${it.name||it.title||'Item'} × ${it.qty||1}`).join(', ');
    const photos = (o.photos || o.itemPhotos || []).slice(0,4).map(u=>`<img src="${u}" alt="">`).join('');
    const total = (o.total!=null) ? `₹${o.total}` : (o.amount!=null ? `₹${o.amount}` : '-');
    const method = (o.method || o.paymentMethod || '—').toUpperCase();
    const status = o.status || 'Placed';
    return `<div class="order-card">
      <div class="row">
        <strong>Order ${o.id ? '#'+o.id : ''}</strong>
        <span class="badge">${status}</span>
      </div>
      <div class="meta">Date: ${formatDate(o.date || o.time)}</div>
      <div class="meta">Items: ${itemsLine || '-'}</div>
      <div class="meta">Total: <strong>${total}</strong> &nbsp;•&nbsp; Method: <strong>${method}</strong></div>
      ${photos ? `<div class="thumbs">${photos}</div>` : ''}
      <a class="track-link" href="${orderTrackUrl(o)}" target="_blank" rel="noopener">Track Order</a>
    </div>`;
  }).join("");
}
function openOrdersPopup(){ document.getElementById('ordersOverlay').style.display='flex'; renderOrders(); }
function closeOrdersPopup(){ document.getElementById('ordersOverlay').style.display='none'; }

/* ========= LOGOUT (preserve orders_by_user) ========= */
function showToast(msg){
  const t = document.getElementById('toast'); t.textContent=msg; t.style.display='block';
  setTimeout(()=>{t.style.display='none';}, 1600);
}
function logout(){
  const ordersMap = getOrdersMap(); // keep
  // Remove only auth/session keys
  const keep = JSON.stringify(ordersMap);
  localStorage.clear();
  localStorage.setItem("orders_by_user", keep);
  showToast("Logged out");
  setTimeout(()=>{ location.href = "/"; }, 350);
}

/* ========= OPTIONAL: MIGRATE old single-key orders -> per-user map ========= */
(function migrateOldOrders(){
  const oldKeys = ["orders","placedOrders","recentOrders","user_orders"];
  let found = null;
  for(const k of oldKeys){
    const val = safeParse(localStorage.getItem(k)||"null", null);
    if (Array.isArray(val) && val.length){ found = val; break; }
  }
  if(found && getCurrentEmail()){
    const map = getOrdersMap();
    map[getCurrentEmail()] = (map[getCurrentEmail()]||[]).concat(found);
    setOrdersMap(map);
    oldKeys.forEach(k=>localStorage.removeItem(k));
  }
})();

/* First render */
renderOrders();
</script>
</body>
</html>
