<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Orders</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial; margin:16px;}
      h1{font-size:18px;margin:0 0 12px;}
      .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
      input,select{padding:8px;border:1px solid #ddd;border-radius:8px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #eee;padding:8px;vertical-align:top;font-size:13px}
      th{background:#fafafa;text-align:left;position:sticky;top:0}
      .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap}
      .pill{display:inline-block;padding:2px 8px;border:1px solid #ccc;border-radius:999px;font-size:12px}
      .note{font-size:12px;color:#666;margin-bottom:8px}
    </style>
  </head>
  <body>
    <h1>Orders</h1>
    <div class="note">Netlify build — fetching from Apps Script.</div>
    <div class="toolbar">
      <input id="q" placeholder="Search name / phone / order id" oninput="render()" />
      <select id="method" onchange="render()">
        <option value="">All methods</option>
        <option>Razorpay</option>
        <option>COD</option>
      </select>
    </div>
    <div id="wrap">Loading…</div>

    <script>
      const API = "https://script.google.com/macros/s/AKfycbxy1MX0Je3l6Kjjr0SUYHRWWj2V1zGtUa94J6m5vPx_7oDGNKWaw6geWDp8Szjt7T4QWw/exec";
      let ORDERS = [];

      async function load() {
        try {
          const res = await fetch(API + '?action=list', { cache: 'no-store' });
          const j = await res.json();
          ORDERS = Array.isArray(j.data) ? j.data : [];
        } catch (e) {
          document.getElementById('wrap').innerHTML = '<div style="color:#b00">Failed to load orders. Check your Apps Script deployment access (Who can access = Anyone).</div>';
          console.warn(e);
          return;
        }
        render();
      }

      function render() {
        const q = (document.getElementById('q').value || '').toLowerCase();
        const m = document.getElementById('method').value;
        const rows = ORDERS.filter(o => {
          const hay = (o.orderId||'') + ' ' + (o.name||'') + ' ' + (o.phone||'');
          const hitQ = !q || hay.toLowerCase().includes(q);
          const hitM = !m || o.paymentMethod === m;
          return hitQ && hitM;
        }).map(o => `
          <tr>
            <td>${new Date(o.timestamp).toLocaleString()}</td>
            <td><b>${o.orderId||''}</b><br><span class="pill">${o.paymentMethod||''}</span></td>
            <td>${o.name||''}<br>${o.phone||''}<br>${o.email||''}</td>
            <td>${o.address||''}</td>
            <td class="mono">${o.itemsJSON||''}</td>
            <td>₹${o.subtotal||0} + ₹${o.deliveryFee||0} ${o.codCharges?('+ ₹'+o.codCharges):''}
              ${o.discount?('<br>- Discount ₹'+o.discount):''}
              <br><b>Total: ₹${o.grandTotal||0}</b>
              ${o.coupon?('<br>Coupon: '+o.coupon):''}
              ${o.razorpayPaymentId?('<br>PID: '+o.razorpayPaymentId):''}
            </td>
            <td>${o.status||'New'}</td>
          </tr>
        `).join('');

        document.getElementById('wrap').innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Time</th><th>Order</th><th>Customer</th><th>Address</th>
                <th>Items</th><th>Amount</th><th>Status</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }

      load();
    </script>
  </body>
</html>
