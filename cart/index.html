<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Cart - Precioussly</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="google-signin-client_id" content="746848628668-83a44mlh0klb2kp8gajhi4j26sd33l61.apps.googleusercontent.com">

  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:'Roboto Slab',serif;color:#111;background:#fff}
    .site-header{background:#fff;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;box-shadow:0 2px 10px rgba(0,0,0,.06);min-height:56px}
    .right-icon{width:28px;height:28px;border-radius:50%;object-fit:cover;cursor:pointer}
    #announcementBar{margin:0;padding:6px 10px;font-size:13px;color:#fff;background:#000;font-weight:500;text-align:center;min-height:24px;line-height:22px;user-select:none}

    .container{max-width:520px;margin:0 auto;padding:18px 12px 110px}
    .section-title{font-size:20px;font-weight:700;margin:6px 0 12px}

    /* Cart item */
    .item{display:flex;gap:12px;align-items:center;background:#fff;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 4px 18px rgba(0,0,0,.05)}
    .item img{width:80px;height:80px;border-radius:12px;object-fit:cover}
    .item-info{flex:1}
    .item-name{font-size:15px;font-weight:700}
    .item-price{font-size:14px;color:#333;margin:4px 0 8px}
    .qty-controls{display:flex;align-items:center;gap:8px}
    .qty-btn{width:30px;height:30px;border:1px solid #ddd;background:#f9f9f9;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .qty-btn:hover{background:#2874f0;color:#fff;transform:scale(1.03)}
    .qty-count{min-width:20px;text-align:center}
    .remove-btn{margin-left:8px;padding:6px 12px;border:1px solid #2874f0;color:#2874f0;background:#fff;border-radius:8px}

    /* Payment box */
    .payment-method-box{margin-top:14px;padding:14px;border-radius:12px;background:#f9f9f9;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    .payment-option{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:15px;font-weight:500;cursor:pointer}
    .payment-option input{display:none}
    .custom-radio{width:20px;height:20px;border:2.5px solid #2874f0;border-radius:50%;position:relative}
    .payment-option input:checked + .custom-radio::before{content:"";width:10px;height:10px;background:#2874f0;border-radius:50%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}

    /* Coupon strip (from sheet) */
    .coupon-strip{display:flex;overflow-x:auto;gap:10px;padding:10px 0;margin-top:6px}
    .coupon-card{background:#e9fef1;border:1px solid #c5ecd6;border-radius:10px;padding:8px 10px;min-width:220px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .coupon-card h3{font-size:15px;margin:0 0 2px;color:#064c2c}
    .coupon-card p{font-size:12px;margin:0 0 6px;color:#064c2c}
    .code-row{display:flex;align-items:center;gap:6px}
    .code-box{background:#d5f5e5;padding:3px 10px;border-radius:6px;font-weight:700;font-size:12px;color:#064c2c;letter-spacing:.3px}

    /* Apply coupon row */
    .apply-row{display:flex;gap:8px;margin-top:12px}
    .apply-input{flex:1;border:1.4px solid #ccc;border-radius:12px;padding:12px 12px;font-size:15px}
    .apply-btn{border:1.4px solid #000;background:#fff;color:#000;border-radius:12px;padding:12px 16px;font-size:15px;white-space:nowrap}
    .applied-note{margin-top:8px;font-size:13px;color:#2874f0}
    .remove-coupon-btn{background:none;border:none;color:#000;text-decoration:underline;margin-left:8px;cursor:pointer}

    /* Summary */
    #summaryBox{background:#f9f9f9;border:1px solid #ddd;border-radius:12px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,.05);margin-top:14px}
    .summary-row{display:flex;justify-content:space-between;margin:8px 0}
    .discount-row span:last-child{color:#0b8f27}

    /* Proceed button with spinner */
    .proceed-btn{position:relative;display:grid;place-items:center;background:#2874f0;color:#fff;width:100%;padding:12px;font-size:16px;margin-top:16px;border:none;border-radius:10px}
    .btn-label{display:inline-block}
    .btn-spinner{position:absolute;inset:0;margin:auto;width:18px;height:18px;border:2px solid rgba(255,255,255,.45);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:none;pointer-events:none}
    .is-loading .btn-label{visibility:hidden}
    .is-loading .btn-spinner{display:block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="https://i.postimg.cc/HnRbjRbh/Best-Logo.png" alt="Precioussly" style="width:110px;cursor:pointer" onclick="location.href='https://precioussly.com'">
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <img id="profileIcon" class="right-icon" src="https://i.postimg.cc/1tRZMmmB/Profile-Icon.png" alt="Profile" onclick="handleProfileClick()">
      <a href="https://www.precioussly.com/cart" style="position:relative;display:inline-block">
        <img class="right-icon" src="https://i.postimg.cc/MZF8bJh0/Cart-Icon.png" alt="Cart">
        <span id="cartCountBadge" style="position:absolute;top:-6px;right:-6px;background:#fff;color:#000;font-size:12px;border:1px solid #999;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center">0</span>
      </a>
    </div>
  </header>

  <!-- Announcement -->
  <div id="announcementBar">ðŸ§¿</div>

  <!-- Main -->
  <div class="container">
    <div class="section-title">Confirm Order</div>

    <!-- Address -->
    <div class="address" style="font-size:15px;line-height:1.5;margin-bottom:12px">
      <strong>Shipping Address</strong><br>
      <div id="displayAddress" style="margin-top:6px"></div>
      <button onclick="openAddressPopup()" style="margin-top:10px;padding:8px 12px;background:#2874f0;color:#fff;border:none;border-radius:8px">Add / Edit Address</button>
    </div>

    <!-- Cart items -->
    <div id="cartItems"></div>

    <!-- Payment -->
    <div id="paymentMethodBox" class="payment-method-box" style="display:none">
      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="razorpay" checked onchange="updatePaymentMethod()">
        <span class="custom-radio"></span> Pay via Razorpay (No Extra Charge)
      </label>
      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="cod" onchange="updatePaymentMethod()">
        <span class="custom-radio"></span> Cash on Delivery (+â‚¹89)
      </label>

      <!-- Coupon strip from the same Google Sheet as home -->
      <div id="couponStrip" class="coupon-strip"></div>

      <!-- Apply coupon row -->
      <div class="apply-row">
        <input id="couponInput" class="apply-input" placeholder="Enter coupon code">
        <button id="applyBtn" class="apply-btn" onclick="manualApply()">Apply Coupon</button>
      </div>
      <div id="appliedNote" class="applied-note" style="display:none"></div>
    </div>

    <!-- Summary -->
    <div id="summaryBox">
      <div class="summary-row"><span>Item Total</span><span id="sumItems">â‚¹0</span></div>
      <div class="summary-row"><span>Delivery Fee</span><span id="sumDelivery">â€”</span></div>
      <div class="summary-row" id="codRow" style="display:none"><span>COD Charges</span><span id="sumCOD">â‚¹89</span></div>
      <div class="summary-row discount-row" id="couponRow" style="display:none"><span>Coupon Discount</span><span id="sumCoupon">-â‚¹0</span></div>
      <div class="summary-row" style="font-weight:700;font-size:18px"><span>Order Total</span><span id="sumTotal">â‚¹0</span></div>
    </div>

    <button id="proceedBtn" class="proceed-btn" onclick="handleProceed()">
      <span class="btn-label">Proceed to Pay</span>
      <span class="btn-spinner" aria-hidden="true"></span>
    </button>
  </div>

  <!-- (Minimal) Address popup -->
  <div id="addressPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999;align-items:center;justify-content:center;padding:16px">
    <div style="background:#fff;width:100%;max-width:360px;border:2px solid #bbb;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px">
      <div style="font-weight:700;margin-bottom:8px">Enter Address</div>
      <input id="fullname" placeholder="Full Name" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:8px 0">
      <input id="address"  placeholder="Address"   style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:8px 0">
      <input id="city"     placeholder="City"      style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:8px 0">
      <input id="state"    placeholder="State"     style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:8px 0">
      <input id="pincode"  placeholder="Pincode"   style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:8px 0">
      <input id="phone"    placeholder="Phone"     style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:8px 0">
      <div style="display:flex;gap:10px;margin-top:10px">
        <button onclick="confirmAddress()" style="flex:1;background:#2874f0;color:#fff;border:none;border-radius:12px;padding:12px">Confirm</button>
        <button onclick="closeAddressPopup()" style="flex:1;background:#fff;color:#000;border:1px solid #ccc;border-radius:12px;padding:12px">Back</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    /* ====== CONFIG (edit IDs if needed) ====== */
    const ANNOUNCE_SHEET_ID = "1tjNd2zp77FVVdJQ181lhwSElZHgk3BT5Ma3_VM9Jafc";   // your existing sheet (announcement + delivery)
    const COUPON_SHEET_ID   = "1AthYJZwY7oCU27aerHzMk8NosYdo2iprEVZmdOGxkXs";   // same one used on home page for coupons

    const announceURL = `https://opensheet.elk.sh/${ANNOUNCE_SHEET_ID}/Sheet1`;
    const couponSheetURL = `https://opensheet.elk.sh/${COUPON_SHEET_ID}/Sheet1`;

    /* ====== STATE ====== */
    let cartData = JSON.parse(localStorage.getItem("cartItems") || "[]");
    let deliveryFee = 0;
    let selectedPayment = "razorpay";
    let coupons = [];              // from sheet
    let appliedCoupon = null;      // { Code, Discount, MinAmount, Title }
    const COD_CHARGE = 89;

    /* ====== HEADER + ANNOUNCEMENT ====== */
    fetch(announceURL).then(r=>r.json()).then(rows=>{
      if(rows[0] && rows[0]["(announcement_text)"]) {
        document.getElementById("announcementBar").innerText = rows[0]["(announcement_text)"];
      }
      // delivery fee (0 means Free Delivery)
      const val = rows[0] && rows[0]["Delivery Fee"] ? String(rows[0]["Delivery Fee"]).trim() : "0";
      deliveryFee = (val === "0") ? 0 : parseFloat(val)||0;
      renderSummary();
    });

    /* ====== COUPONS FROM SHEET ====== */
    fetch(couponSheetURL).then(r=>r.json()).then(data=>{
      // Expecting columns: Title, MinAmount, Code, Discount  (flat â‚¹ off)
      coupons = data
        .filter(c => c.Code && c.MinAmount && c.Discount)
        .map(c => ({
          Title: (c.Title||"").trim(),
          Code: (c.Code||"").trim().toUpperCase(),
          MinAmount: Number(c.MinAmount)||0,
          Discount: Number(c.Discount)||0
        }));
      renderCouponStrip();
      autoApplyBestCoupon();
      renderSummary();
    });

    function renderCouponStrip(){
      const strip = document.getElementById("couponStrip");
      strip.innerHTML = "";
      coupons.forEach(c=>{
        const card = document.createElement("div");
        card.className = "coupon-card";
        card.innerHTML = `
          <h3>${c.Title || ("GET â‚¹"+c.Discount+" off")}</h3>
          <p>Buy for min of â‚¹${c.MinAmount}</p>
          <div class="code-row">
            <div class="code-box">${c.Code}</div>
            <button style="border:none;background:none;text-decoration:underline;cursor:pointer" onclick="applyByCode('${c.Code}')">Apply</button>
          </div>
        `;
        strip.appendChild(card);
      });
    }

    /* ====== CART RENDER ====== */
    function renderCart(){
      const container = document.getElementById("cartItems");
      container.innerHTML = "";
      if(cartData.length === 0){
        container.innerHTML = `
          <div style="text-align:center;margin-top:30px">
            <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" style="width:80px;opacity:.5">
            <p style="font-size:16px;color:#555">Your cart is empty.</p>
            <button onclick="location.href='https://precioussly.com/'" style="margin-top:16px;background:#2874f0;color:#fff;border:none;padding:10px 24px;border-radius:30px">Continue Shopping</button>
          </div>`;
        document.getElementById("paymentMethodBox").style.display = "none";
        document.getElementById("proceedBtn").style.display = "none";
        return;
      }

      document.getElementById("paymentMethodBox").style.display = "block";
      document.getElementById("proceedBtn").style.display = "block";

      cartData.forEach((item, i)=>{
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <img src="${item.photo}">
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="item-price">â‚¹${item.price}</div>
            <div class="qty-controls">
              <button class="qty-btn" onclick="decrease(${i})">-</button>
              <span id="qty-${i}" class="qty-count">${item.qty}</span>
              <button class="qty-btn" onclick="increase(${i})">+</button>
              <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
            </div>
          </div>`;
        container.appendChild(row);
      });
    }

    function subtotal(){ return cartData.reduce((s,it)=>s + Number(it.price)*Number(it.qty), 0); }

    /* ====== COUPON LOGIC ====== */
    function bestCouponFor(amount){
      // returns coupon with max Discount where amount >= MinAmount
      const eligible = coupons.filter(c => amount >= c.MinAmount);
      if(!eligible.length) return null;
      eligible.sort((a,b)=> b.Discount - a.Discount);
      return eligible[0];
    }

    function autoApplyBestCoupon(){
      const best = bestCouponFor(subtotal());
      const savedManual = (localStorage.getItem("appliedCouponCode") || "").toUpperCase();
      const manual = coupons.find(c=>c.Code===savedManual);

      // If user manually chose a code and it's still eligible, keep it. Otherwise use best.
      const stillValidManual = manual && subtotal() >= manual.MinAmount;
      appliedCoupon = stillValidManual ? manual : best;
      localStorage.setItem("appliedCouponCode", appliedCoupon ? appliedCoupon.Code : "");
      showAppliedNote();
    }

    function applyByCode(code){
      document.getElementById("couponInput").value = code;
      manualApply();
    }

    function manualApply(){
      const code = (document.getElementById("couponInput").value || "").trim().toUpperCase();
      const found = coupons.find(c=>c.Code===code);
      if(!found){ toast("Invalid coupon code"); return; }
      if(subtotal() < found.MinAmount){ toast(`Add items worth â‚¹${found.MinAmount - subtotal()} more to use ${found.Code}`); return; }
      appliedCoupon = found;
      localStorage.setItem("appliedCouponCode", found.Code);
      showAppliedNote(true);
      renderSummary();
    }

    function clearCoupon(){
      appliedCoupon = null;
      localStorage.removeItem("appliedCouponCode");
      showAppliedNote();
      renderSummary();
    }

    function showAppliedNote(isManual=false){
      const note = document.getElementById("appliedNote");
      if(!appliedCoupon){ note.style.display="none"; return; }
      note.style.display="block";
      note.innerHTML = `Applied: <b>${appliedCoupon.Code}</b> (â‚¹${appliedCoupon.Discount} off)
        <button class="remove-coupon-btn" onclick="clearCoupon()">Remove</button>`;
      if(!isManual){
        const best = bestCouponFor(subtotal());
        if(best && appliedCoupon && best.Code !== appliedCoupon.Code){
          // Shouldnâ€™t happen, but keep the truly best
          appliedCoupon = best;
          localStorage.setItem("appliedCouponCode", best.Code);
        }
      }
    }

    /* ====== SUMMARY ====== */
    function renderSummary(){
      const items = subtotal();
      const isCOD = (selectedPayment === "cod");
      const codFee = isCOD ? COD_CHARGE : 0;

      // validate coupon each time
      if(appliedCoupon && subtotal() < appliedCoupon.MinAmount){ appliedCoupon = null; localStorage.removeItem("appliedCouponCode"); }

      const couponOff = appliedCoupon ? appliedCoupon.Discount : 0;
      const deliveryText = deliveryFee === 0 ? '<span style="color:green">Free Delivery</span>' : `â‚¹${deliveryFee}`;

      document.getElementById("sumItems").innerText = `â‚¹${items}`;
      document.getElementById("sumDelivery").innerHTML = deliveryText;
      document.getElementById("codRow").style.display = isCOD ? "flex" : "none";
      document.getElementById("sumCOD").innerText = `â‚¹${codFee}`;
      document.getElementById("couponRow").style.display = couponOff>0 ? "flex" : "none";
      document.getElementById("sumCoupon").innerText = `-â‚¹${couponOff}`;

      const grand = Math.max(0, items + deliveryFee + codFee - couponOff);
      document.getElementById("sumTotal").innerText = `â‚¹${grand}`;
    }

    /* ====== QTY HANDLERS ====== */
    function persist(){ localStorage.setItem("cartItems", JSON.stringify(cartData)); }
    function increase(i){ cartData[i].qty++; persist(); document.getElementById(`qty-${i}`).innerText=cartData[i].qty; autoApplyBestCoupon(); renderSummary(); updateCartBadge(); }
    function decrease(i){
      if(cartData[i].qty>1){ cartData[i].qty--; persist(); document.getElementById(`qty-${i}`).innerText=cartData[i].qty; autoApplyBestCoupon(); renderSummary(); updateCartBadge(); }
    }
    function removeItem(i){
      cartData.splice(i,1); persist(); autoApplyBestCoupon(); renderCart(); renderSummary(); updateCartBadge();
    }

    /* ====== PAYMENT ====== */
    function updatePaymentMethod(){
      selectedPayment = document.querySelector('input[name="paymentMethod"]:checked').value;
      document.querySelector('#proceedBtn .btn-label').textContent = selectedPayment === "cod" ? "Continue with COD" : "Proceed to Pay";
      renderSummary();
    }

    function handleProceed(){
      const btn = document.getElementById("proceedBtn");
      btn.classList.add("is-loading");
      setTimeout(()=>{
        btn.classList.remove("is-loading");
        if(selectedPayment==="cod"){
          // COD flow (save order etc). Replace with your real flow.
          alert("COD flow goes here.");
        }else{
          // Razorpay flow (open checkout). Replace with your real flow.
          alert("Razorpay flow goes here.");
        }
      },1000);
    }

    /* ====== ADDRESS ====== */
    function openAddressPopup(){ document.getElementById("addressPopup").style.display="flex"; }
    function closeAddressPopup(){ document.getElementById("addressPopup").style.display="none"; }
    function confirmAddress(){
      const name = document.getElementById("fullname").value.trim();
      const addr = document.getElementById("address").value.trim();
      const city = document.getElementById("city").value.trim();
      const state = document.getElementById("state").value.trim();
      const pin = document.getElementById("pincode").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const html = `<strong>${name}</strong><br>${addr},<br>${city}, ${state} - ${pin}<br><strong>${phone}</strong>`;
      localStorage.setItem("shippingAddress", html);
      document.getElementById("displayAddress").innerHTML = html;
      closeAddressPopup();
    }

    /* ====== PROFILE/CART BADGE ====== */
    function handleProfileClick(){
      const isLoggedIn = localStorage.getItem("user_email");
      if(isLoggedIn){ location.href="/dashboard"; }
      else{
        location.href = `https://accounts.google.com/o/oauth2/v2/auth?client_id=746848628668-83a44mlh0klb2kp8gajhi4j26sd33l61.apps.googleusercontent.com&redirect_uri=https://precioussly.com&response_type=token&scope=email%20profile&prompt=consent`;
      }
    }
    function updateCartBadge(){
      const items = JSON.parse(localStorage.getItem("cartItems")||"[]");
      const count = items.reduce((s,it)=>s+Number(it.qty||0),0);
      const badge = document.getElementById("cartCountBadge");
      if(count>0){ badge.style.display="flex"; badge.innerText=count; } else { badge.style.display="none"; }
    }

    /* ====== TOAST ====== */
    function toast(msg){
      const t = document.createElement("div");
      t.textContent = msg;
      t.style.cssText = "position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;z-index:99999";
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),1600);
    }

    /* ====== INIT ====== */
    (function init(){
      // Address on load
      const saved = localStorage.getItem("shippingAddress");
      if(saved) document.getElementById("displayAddress").innerHTML = saved;

      // Profile photo if saved
      const photo = localStorage.getItem("user_photo");
      if(photo) document.getElementById("profileIcon").src = photo;

      renderCart();
      autoApplyBestCoupon();
      renderSummary();
      updateCartBadge();

      // Restore previously applied coupon if any
      const savedCode = (localStorage.getItem("appliedCouponCode")||"").toUpperCase();
      if(savedCode) { document.getElementById("couponInput").value = savedCode; }
      showAppliedNote();
    })();
  </script>
</body>
</html>