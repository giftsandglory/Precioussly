<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Orders from Google Sheet → Full-Height Popup (FIXED + Lightbox)</title>
<style>
  :root{
    --bg:#f1f3f8; --surface:#fff; --muted:#6c7280; --ink:#101318; --accent:#2563eb;
    --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.12); --pad:clamp(10px,2.2vh,16px);
    --green-ink:#0f6a2a; --green-bg:#eafaf0; --green-bg-hover:#def7e7; --green-border:#d9f3df;
  }
  *{ -webkit-tap-highlight-color:transparent; box-sizing:border-box; }
button, .btn-copy { user-select:none; }
  html,body{ margin:0; background:var(--bg);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    color:var(--ink);
  }

  .wrap{ min-height:100dvh; padding:20px 16px 40px; display:flex; justify-content:center; }
  .list{ width:clamp(320px, 92vw, 720px); display:grid; gap:16px; }
  .center{ display:grid; place-items:center; color:#6b7280; padding:40px 0; }

  .order-card{ user-select:text; -webkit-user-select:text;
    background:var(--surface); border-radius:var(--radius); box-shadow:0 6px 20px rgba(0,0,0,.08);
    padding:18px 20px; cursor:pointer; transition:.25s ease;
  }
  .order-card:hover{ transform:translateY(-1px) }

  .summary-card{
    user-select:none;
    background:var(--surface);
    border-radius:var(--radius);
    box-shadow:0 6px 20px rgba(0,0,0,.08);
    padding:18px 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    font-weight:800;
    font-size:clamp(18px,3.3vw,22px);
    letter-spacing:.02em;
    border:1px solid #eef0f4;
  }
  .summary-card .count{
    font-size:clamp(22px,3.6vw,28px);
    color:var(--accent);
  }

  .row{ display:flex; justify-content:space-between; align-items:center; gap:16px; color:#6f757d; font-weight:600; letter-spacing:.02em; font-size:14px; }
  .name{
    margin:.45rem 0 0 0;
    font-size:clamp(22px,3.5vw,30px);
    font-weight:800;
    display:flex;
    align-items:center;
    gap:8px;
    line-height:1.2;
  }
  .name .wa{
    width:1.35em;
    height:1.35em;
    flex:0 0 auto;
    display:inline-block;
    vertical-align:middle;
  }

  .phone-btn{
    width:1.35em;
    height:1.35em;
    flex:0 0 auto;
    display:inline-grid;
    place-items:center;
    border:none;
    background:transparent;
    padding:0;
    margin-left:2px;
    cursor:pointer;
  }
  .phone-btn:active{ transform:scale(.96) }
  .phone-btn svg{ width:100%; height:100%; stroke:#0b1a2b; }

  .item{ margin:.15rem 0 0 0; font-size:clamp(14px,2.7vw,18px); color:#7a8088; font-style:italic; }
  .amt{ margin-top:.5rem; font-size:clamp(22px,3.6vw,32px); font-weight:800; color:var(--accent); }

  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:var(--pad);
    background:rgba(10,14,20,.28); backdrop-filter:blur(6px); z-index:40; }
  .modal.show{ display:flex }

  .sheet{
    background:var(--surface); border-radius:22px; width:min(96vw, 980px);
    height:calc(100dvh - (var(--pad) * 2)); max-height:100dvh; box-shadow:var(--shadow);
    display:flex; flex-direction:column; overflow:hidden;
  }
  .sheet-header{ padding:14px 18px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eef0f4; }
  .sheet-title{ font-weight:800; letter-spacing:.02em; }
  .close{ display:grid; place-items:center; width:38px; height:38px; border-radius:12px; border:1px solid #e8eaf0; background:#f6f7fb; cursor:pointer; }
  .close:active{ transform:scale(.96) }
  .sheet-body{ flex:1; overflow:auto; padding:14px 18px 18px; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action:pan-y; }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width:760px){ .grid{ grid-template-columns:1fr; } }
  .field{ padding:12px; border:1px solid #eef0f4; border-radius:14px; background:#fff; }
  .label{ font-size:12px; color:var(--muted); letter-spacing:.03em; margin-bottom:6px; font-weight:700; }
  .value{ font-size:14.5px; color:#252a31; line-height:1.35; word-break:break-word; user-select:text; }

  .thumbs{ display:flex; gap:8px; flex-wrap:wrap; }
  .thumbs img,
.thumbs video {
  width:76px;
  height:76px;
  object-fit:cover;
  border-radius:10px;
  border:1px solid #eef0f4;
}


  .details{ display:grid; gap:10px; }
  .details .row{ display:block; color:#252a31; font-weight:500; }
  .details .k{ font-size:12px; color:var(--muted); letter-spacing:.03em; font-weight:700; display:block; margin-bottom:4px; }
  .details .v{ font-size:14.5px; }

  .field-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px; }
  .name .wa{
  width: 32px;
  height: 32px;
  border-radius: 50%;
  flex: 0 0 32px;
}
  .btn-copy{
    appearance:none; border:1px solid var(--green-border); background:var(--green-bg);
    color:var(--green-ink); padding:10px 14px; border-radius:10px; font-weight:800; font-size:13px;
    display:inline-flex; align-items:center; gap:8px; cursor:pointer;
  }
  .btn-copy:hover{ background:var(--green-bg-hover); }
  .btn-copy:active{ transform:translateY(1px) }

  .no-scroll{ height:100vh; overflow:hidden; }
  .empty{ opacity:.7; }
  .spinner{ width:28px; height:28px; border-radius:999px; border:3px solid #e5e7eb; border-top-color:#9aa0a6; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .toast{
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
    background:#0f172a; color:#fff; border-radius:14px; padding:10px 14px;
    font-weight:700; font-size:13px; opacity:0; pointer-events:none; transition:.25s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,.2);
  }
  .toast.show{ opacity:1 }

  /* LIGHTBOX */
  .lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(10,14,20,.86); z-index:60; }
  .lightbox.show{ display:flex; }
.lightbox img,
.lightbox video{
  max-width:92vw; max-height:86vh; width:auto; height:auto;
  border-radius:18px; box-shadow:0 18px 60px rgba(0,0,0,.45);
  transform:translateY(-160px);
}

  
  .lightbox .lb-close:active{ transform:scale(.96) }
</style>
</head>
<body>
  <div class="wrap">
    <div id="orderList" class="list" aria-live="polite">

      <div id="summaryCard" class="summary-card" role="status" aria-live="polite">Total Orders — <span id="orderCount" class="count">0</span></div>
      <div class="center"><div class="spinner" aria-label="Loading"></div></div>
    </div></div>
    </div>
  </div>

  <div id="modalRoot"></div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <!-- Lightbox root -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
  <img id="lightboxImg" alt="Preview" />
  <video id="lightboxVideo" playsinline controls style="display:none"></video>
</div>


<script>
// ====== CONFIG ======
const SHEET_ID   = "1wfMl8tSlmfVgoSvnFI6gHEDpmvJsF5wdOQdhFowmngo";
const SHEET_NAME = "Sheet1";
const SHEET_GID  = "";

// ====== UTIL ======
const fmtINR = n => isFinite(n) ? new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(n) : "";
const safe = s => (s!==null && s!==undefined && String(s).trim()!=="") ? String(s).trim() : "";
const firstOr = (s, alt="") => s ? String(s).split("|")[0].trim() : alt;

function normalizeToDate(val){
  if(val===null || val===undefined || val==="") return null;
  if(typeof val === "number"){
    const ms = Math.round((val - 25569) * 86400) * 1000;
    return new Date(ms);
  }
  const s = String(val).trim();
  const m = s.match(/^Date\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+),\s*(\d+))?\)$/);
  if(m){ return new Date(+m[1], +m[2], +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0)); }
  if(/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}/.test(s)){ return new Date(s.replace(" ","T")+("+05:30")); }
  const t = Date.parse(s);
  return isNaN(t) ? null : new Date(t);
}
function timeFromIST(val){
  const d = normalizeToDate(val);
  if(!d) return safe(val) || "—";
  try{
    return d.toLocaleString("en-IN",{
      timeZone: "Asia/Kolkata",
      year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
    }).replace(","," –");
  }catch(e){ return "—"; }
}
const getField = (o, keys) => { for(const k of keys){ const v=o[k]; if(v!==undefined && v!==null && String(v).trim()!="") return v; } return ""; };

// ====== COPY HELPERS ======
function buildCopyText(o){
  const name = safe(o["Customer Name"]);
  const address = safe(o["Full Address"]).replace(/[\s\n\r]+/g, " ").trim();
  const phone = safe(o["Phone Number"]);
  const alt = safe(o["Alternate Phone Number"]);
  const blocks = [name, address, phone, alt].filter(Boolean);
  return blocks.join("\n\n");
}
async function copyToClipboard(str){
  try{
    await navigator.clipboard.writeText(str);
    return true;
  }catch(err){
    const ta = document.createElement('textarea');
    ta.value = str;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(e){ document.body.removeChild(ta); return false; }
  }
}

// ====== SUMMARY ======
function updateTotal(n){
  const el = document.getElementById('orderCount');
  if(el) el.textContent = (isFinite(n)? Number(n): 0);
}

function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1400);
}

// ====== TEMPLATES ======
function phoneSVG(){
  return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72c.12.9.32 1.77.59 2.61a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.47-1.47a2 2 0 0 1 2.11-.45c.84.27 1.71.47 2.61.59A2 2 0 0 1 22 16.92z"></path>
  </svg>`;
}

function cardHTML(o, idx){
  const orderTime = timeFromIST(o["Order Timestamp (IST)"]);
  const firstItem = safe(firstOr(o['Items (Name × Quantity; pipe-separated)'], ""));
  const totalLabel = safe(o["Order Total (₹)"]);
  const total = isFinite(+totalLabel) ? fmtINR(+totalLabel) : totalLabel;
  return `
  <article class="order-card" data-idx="${idx}" aria-label="Order ${o["Order ID"]}">
    <div class="row">
      <span>ORDER#${o["Order ID"]}</span>
      <span>${orderTime}</span>
    </div>
    <h2 class="name">
      <span>${safe(o["Customer Name"]) || "—"}</span>
      <img class="wa" src="https://i.postimg.cc/L6YgQyRH/cropped-circle-image-1.png" alt="WhatsApp" loading="lazy" decoding="async">
      <button class="phone-btn" type="button" aria-label="Call customer">
        ${phoneSVG()}
      </button>
    </h2>
    <p class="item">${firstItem || ""}</p>
    <div class="amt">${total}</div>
  </article>`;
}

function modalHTML(o, idx){
  const images = (o["Item Image URLs"] || "").split("|").map(s => s.trim()).filter(Boolean);
  const thumbs = images.map(src => {
  if (isVideoUrl(src)) {
    return `<video class="thumb" src="${src}" muted autoplay loop playsinline></video>`;
  } else {
    return `<img class="thumb" src="${src}" data-full="${src}" alt="Item image">`;
  }
}).join("");


  const field = (label, value, wide=false) => `
    <div class="field" ${wide ? 'style="grid-column:1/-1"' : ""}>
      <div class="label">${label}</div>
      <div class="value">${safe(value) || "—"}</div>
    </div>`;

  const detailsBox = `
  <div class="field" style="grid-column:1/-1">
    <div class="field-head">
      <div class="label" style="margin:0">Customer Details</div>
      <button type="button" class="btn-copy" data-copy="${idx}" aria-label="Copy and Use">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <rect x="9" y="9" width="13" height="13" rx="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        Copy and Use
      </button>
    </div>
    <div class="value">
      <div class="details">
        <div class="row">
          <span class="k">Customer Name</span>
          <span class="v">${safe(o["Customer Name"]) || "—"}</span>
        </div>
        <div class="row">
          <span class="k">Full Address</span>
          <span class="v">${safe(o["Full Address"]) || "—"}</span>
        </div>
        <div class="row">
          <span class="k">Phone Number</span>
          <span class="v">${safe(o["Phone Number"]) || "—"}</span>
        </div>
        <div class="row">
          <span class="k">Alternate Phone Number</span>
          <span class="v">${safe(o["Alternate Phone Number"]) || "—"}</span>
        </div>
      </div>
    </div>
  </div>`;

  const pincode = getField(o, ["Postal Code (Pincode)", "Pincode", "Postal Code", "Pin code", "Pin Code"]);

  return `
  <div class="modal" id="modal-${idx}" data-idx="${idx}" aria-hidden="true">
    <section class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle-${idx}">
      <header class="sheet-header">
        <div class="sheet-title" id="sheetTitle-${idx}">ORDER DETAILS — #${o["Order ID"]}</div>
        <button class="close" data-close="${idx}" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0b1a2b" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </header>
      <div class="sheet-body">
        <div class="grid">
          ${field("Order ID", o["Order ID"])}
          ${field("Order Timestamp (IST)", timeFromIST(o["Order Timestamp (IST)"]))}
          ${detailsBox}
          ${field("Customer Email", o["Customer Email"] || o["Email"])}
          ${field("City", o["City"])}
          ${field("State", o["State"])}
          ${field("Postal Code (Pincode)", pincode)}
          ${field("Payment Method (Razorpay / Cash on Delivery)", o["Payment Method (Razorpay / Cash on Delivery)"])}
          ${field("Payment Status (Paid / Unpaid / Prepaid-COD)", o["Payment Status (Paid / Unpaid / Prepaid-COD)"])}
          ${field("Payment Reference (Razorpay Payment ID / COD Reference)", o["Payment Reference (Razorpay Payment ID / COD Reference)"], true)}
          ${field("COD Prepaid Amount (₹)", o["COD Prepaid Amount (₹)"])}
          ${field("COD Charges (₹)", o["COD Charges (₹)"])}
          ${field("Coupon Code", o["Coupon Code"])}
          ${field("Discount Amount (₹)", o["Discount Amount (₹)"])}
          ${field('Delivery Fee (₹ or "Free Delivery")', o['Delivery Fee (₹ or "Free Delivery")'])}
          ${field("Item Count", o["Item Count"])}
          ${field("Items (Name × Quantity; pipe-separated)", o["Items (Name × Quantity; pipe-separated)"], true)}
          <div class="field" style="grid-column:1/-1">
            <div class="label">Item Image URLs</div>
            <div class="value ${images.length? "" : "empty"}">
              ${images.length ? `<div class="thumbs">${thumbs}</div>` : "—"}
            </div>
          </div>
          ${field("Subtotal (₹)", o["Subtotal (₹)"])}
          ${field("Order Total (₹)", o["Order Total (₹)"])}
        </div>
      </div>
    </section>
  </div>`;
}

// ====== FETCH SHEET ======
async function getSheetRows(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${encodeURIComponent(SHEET_NAME)}`;
  try{
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 9000);
    const res = await fetch(url, {signal: ctrl.signal, cache: "no-store"});
    clearTimeout(t);
    const text = await res.text();
    const jsonStart = text.indexOf("{");
    const jsonEnd = text.lastIndexOf("}");
    if(jsonStart === -1 || jsonEnd === -1) throw new Error("Unexpected GViz response");
    const json = JSON.parse(text.slice(jsonStart, jsonEnd + 1));

    const cols = (json.table.cols || []).map(c => (c.label || "").trim());
    const rows = (json.table.rows || []).map(r => {
      const obj = {};
      cols.forEach((h, i) => { obj[h] = (r.c[i] && r.c[i].v != null) ? r.c[i].v : ""; });
      return obj;
    });
    if(rows.length && rows[0]["Order ID"] === "Order ID"){ rows.shift(); }
    return rows.filter(r => r["Order ID"]);
  }catch(e){
    console.warn("GViz fetch failed, trying CSV. Reason:", e.message || e);
    if(!SHEET_GID) return null;
    try{
      const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
      const res2 = await fetch(csvUrl, {cache: "no-store"});
      const csv = await res2.text();
      const [headerLine, ...lines] = csv.split(/\r?\n/).filter(Boolean);
      const headers = headerLine.split(",").map(h => h.trim());
      const out = lines.map(line => {
        const cells = line.split(",").map(v => v.trim());
        const o = {};
        headers.forEach((h,i)=>o[h]=cells[i]||"");
        return o;
      });
      return out.filter(r=>r["Order ID"]);
    }catch(err){
      console.warn("CSV fallback failed:", err.message || err);
      return null;
    }
  }
}

// ====== LIGHTBOX API ======
function openLightbox(src){
  const lb = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = src;
  lb.classList.add('show');
  lb.setAttribute('aria-hidden','false');
  document.body.classList.add('no-scroll');
}
function closeLightbox(){
  const lb = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = "";
  lb.classList.remove('show');
  lb.setAttribute('aria-hidden','true');
  document.body.classList.remove('no-scroll');
}


function isVideoUrl(url){
  if (!url) return false;
  url = String(url).split('?')[0].split('#')[0].trim().toLowerCase();
  return url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg');
}
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lightboxImg');
const lbVid = document.getElementById('lightboxVideo');

function openLightbox(url){
  if (isVideoUrl(url)) {
    // video dikhana hai
    lbImg.style.display = 'none';
    lbVid.style.display = '';
    lbVid.src = url;
    lbVid.muted = false;       // audio allowed
    lbVid.autoplay = true;     // auto play
    lbVid.currentTime = 0;     // shuru se play
  } else {
    // image dikhana hai
    lbVid.pause();
    lbVid.removeAttribute('src');
    lbVid.style.display = 'none';
    lbImg.style.display = '';
    lbImg.src = url;
  }
  lb.classList.add('show');  // popup open karo
}
document.addEventListener('click', (e) => {
  const t = e.target;
  if (!t.classList.contains('thumb')) return;

  // agar img hai to t.dataset.full ya t.src lo, 
  // agar video hai to t.currentSrc use karo
  const url = t.dataset.full || t.currentSrc || t.src;
  if (url) openLightbox(url);
});
function closeLightbox(){
  const lb = document.getElementById('lightbox');
  const lbVid = document.getElementById('lightboxVideo');
  if (!lb) return;
  lb.classList.remove('show');
  if (lbVid) {
    lbVid.pause();
    lbVid.removeAttribute('src');
  }
}

// click outside media to close
document.getElementById('lightbox').addEventListener('click', (e)=>{
  if (e.target.id === 'lightbox') closeLightbox();
});

// ESC key se close
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') closeLightbox();
});


// ====== INTERACTION ======
function attachHandlers(){
  document.querySelectorAll(".order-card").forEach(card=>{
    card.addEventListener("click", (e)=>{
      const sel = (window.getSelection && window.getSelection().toString()) || "";
      if(sel && sel.length > 0){ return; }
      const idx = card.getAttribute("data-idx");
      const modal = document.getElementById(`modal-${idx}`);
      if(modal){
        modal.classList.add("show");
        modal.setAttribute("aria-hidden","false");
        document.body.classList.add("no-scroll");
      }
    });
  });
  document.querySelectorAll("[data-close]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = btn.getAttribute("data-close");
      const m = document.getElementById(`modal-${idx}`);
      if(m){ m.classList.remove("show"); m.setAttribute("aria-hidden","true"); document.body.classList.remove("no-scroll"); }
    });
  });
  document.querySelectorAll(".modal").forEach(m=>{
    m.addEventListener("click", (e)=>{ if(e.target === m){ m.classList.remove("show"); document.body.classList.remove("no-scroll"); }});
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      document.querySelectorAll(".modal.show").forEach(m=>m.classList.remove("show"));
      document.body.classList.remove("no-scroll");
      closeLightbox();
    }
  });

  // Copy button
  document.querySelectorAll(".btn-copy").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const idx = +btn.getAttribute("data-copy");
      const o = (window.__ORDERS || [])[idx] || {};
      const text = buildCopyText(o);
      const ok = await copyToClipboard(text);
      showToast(ok ? "Copied to clipboard" : "Copy failed");
    });
  });

  // Phone button (open dialer)
  document.querySelectorAll(".phone-btn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      const card = btn.closest(".order-card");
      const idx = card && card.getAttribute("data-idx");
      const o = (window.__ORDERS || [])[idx] || {};
      let raw = (o["Phone Number"] || o["Alternate Phone Number"] || "").toString();
      let digits = raw.replace(/[^\d]/g,"").replace(/^0+/,"");
      if(!digits){ showToast("No phone number"); return; }
      if(digits.length === 10){ digits = "91" + digits; }
      const tel = "tel:+" + digits;
      try{ window.location.href = tel; }catch(_){ showToast("Could not open dialer"); }
    });
  });

  // Lightbox open on thumbnail click
  document.querySelectorAll(".thumbs img.thumb").forEach(img=>{
    img.addEventListener("click", (e)=>{
      e.stopPropagation();
      const src = img.getAttribute("data-full") || img.src;
      openLightbox(src);
    });
  });

  // Lightbox close
  document.getElementById('lightbox').addEventListener('click', (e)=>{
    if(e.target.id === 'lightbox' || e.target.closest('.lb-close')) closeLightbox();
  });
}

// ====== MAIN ======
async function main(){
  const list = document.getElementById("orderList");
  const modalRoot = document.getElementById("modalRoot");
  list.innerHTML = `<div class="center"><div class="spinner" aria-label="Loading"></div></div>`;

  const rows = await getSheetRows();

  
  const data = rows && rows.length ? rows : [{
    "Order ID":"COD-1757229331357",
    "Order Timestamp (IST)":"2025-09-07 12:45:00",
    "Customer Name":"gifts.and.glory_",
    "Full Address":"Pradhan Enclave buradi Delhi, Delhi, Delhi - 110084",
    "Phone Number":"8744841734",
    "Alternate Phone Number":"788",
    "Customer Email":"ask.gifts.and.glory@gmail.com",
    "City":"Delhi",
    "State":"Delhi",
    "Postal Code (Pincode)":"110084",
    "Payment Method (Razorpay / Cash on Delivery)":"Cash on Delivery",
    "Payment Status (Paid / Unpaid / Prepaid-COD)":"Unpaid",
    "Payment Reference (Razorpay Payment ID / COD Reference)":"—",
    "COD Prepaid Amount (₹)":"0",
    "COD Charges (₹)":"89",
    "Coupon Code":"—",
    "Discount Amount (₹)":"0",
    "Delivery Fee (₹ or \"Free Delivery\")":"Free Delivery",
    "Item Count":"1",
    "Items (Name × Quantity; pipe-separated)":"Sunset Resin Tray × 1",
    "Item Image URLs":"",
    "Subtotal (₹)":"1099",
    "Order Total (₹)":"1099"
  }];

  // === NEW: Always show newest orders first ===
  const sorted = (data || []).slice().sort((a, b) => {
    const da = normalizeToDate(a["Order Timestamp (IST)"]);
    const db = normalizeToDate(b["Order Timestamp (IST)"]);
    if (da && db && !isNaN(da) && !isNaN(db)) return db - da; // newer first
    const na = parseInt(String(a["Order ID"] || "").replace(/[^0-9]/g, "")) || 0;
    const nb = parseInt(String(b["Order ID"] || "").replace(/[^0-9]/g, "")) || 0;
    return nb - na;
  });

  window.__ORDERS = sorted;

  const summaryHTML = `<div id="summaryCard" class="summary-card" role="status" aria-live="polite">Total Orders — <span id="orderCount" class="count">${sorted.length}</span></div>`;
  list.innerHTML = summaryHTML + sorted.map((o, i) => cardHTML(o, i)).join("");
  updateTotal(sorted.length);
  modalRoot.innerHTML = sorted.map((o, i) => modalHTML(o, i)).join("");
  attachHandlers();

  if(!rows){
    const info = document.createElement("div");
    info.className = "center";
    info.innerHTML = "<small>Showing demo order because the Google Sheet could not be loaded right now.</small>";
    const summary = document.getElementById("summaryCard");
    if(summary){ list.insertBefore(info, summary.nextSibling); } else { list.prepend(info); }
  }else if(rows && !rows.length){
    list.innerHTML = `<div id="summaryCard" class="summary-card" role="status" aria-live="polite">Total Orders — <span id="orderCount" class="count">0</span></div>` +
      `<div class="order-card empty">No orders found in the sheet.</div>`;
    updateTotal(0);
  }
}

document.addEventListener("DOMContentLoaded", main);
</script>

<!-- WhatsApp Autofill (non-invasive) -->
<script>
(function(){
  function sanitizePhone(raw){
    const digits = String(raw||"").replace(/[^\d]/g, "");
    if(!digits) return "";
    let n = digits.replace(/^0+/, "");
    if(n.length === 10) n = "91" + n; // assume India if 10 digits
    return n;
  }
  function fmtINR(n){ try{ return new Intl.NumberFormat('en-IN', {style:'currency', currency:'INR', maximumFractionDigits:0}).format(+n||0);}catch(e){ return "₹"+(n||0);}}
  function timeFromIST(s){
    try{
      if(!s) return "—";
      const parseDate = (typeof normalizeToDate === 'function') ? normalizeToDate : (val => {
        const str = String(val).trim();
        const m = str.match(/^Date\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+),\s*(\d+))?\)$/);
        if(m){ return new Date(+m[1], +m[2], +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0)); }
        const t = Date.parse(str);
        return isNaN(t) ? null : new Date(t);
      });
      const d = parseDate(s);
      if(!d || isNaN(d)) return String(s);
      const opts = { day:'2-digit', month:'short', year:'numeric', hour:'numeric', minute:'2-digit', hour12:true, timeZone:'Asia/Kolkata' };
      return d.toLocaleString('en-IN', opts).replace(',', ' —');
    }catch(e){ return String(s); }
  }
  function safe(v){ return (v==null?"":String(v)); }
  function buildOrderDetails(o){
    const id = safe(o["Order ID"]);
    const when = timeFromIST(o["Order Timestamp (IST)"]);
    const items = safe(o["Items (Name × Quantity; pipe-separated)"]);
    const itemLines = items ? items.split("|").map(s=>s.trim()).filter(Boolean).map(s=>"• "+s).join("\n") : "";
    const total = safe(o["Order Total (₹)"]);
    const payMethod = safe(o["Payment Method (Razorpay / Cash on Delivery)"]);
    const payStatus = safe(o["Payment Status (Paid / Unpaid / Prepaid-COD)"]);
    const parts = [];
    if(id) parts.push("Order ID: "+id);
    if(when && when !== "—") parts.push("Order Date: "+when);
    if(itemLines) parts.push("Items:\n"+itemLines);
    if(total) parts.push("Total: "+(isFinite(+total)? fmtINR(+total): total));
    if(payMethod) parts.push("Payment Method: "+payMethod);
    if(payStatus) parts.push("Payment Status: "+payStatus);
    return parts.join("\n");
  }
  function buildWhatsAppText(o){
    const details = buildOrderDetails(o);
    const header = "━━━━━━━━━━━━━━━━━━━━━━\nThank you for choosing Precioussly\n━━━━━━━━━━━━━━━━━━━━━━";
    const body = "\n\nYour Order Details\n" + (details || "(Details unavailable)") +
                 "\n\nOnce your order is dispatched,\nyou will be able to track it directly on our website:\nwww.precioussly.com\n\nWe truly appreciate your trust in us.\n━━━━━━━━━━━━━━━━━━━━━━";
    return header + body;
  }
  function onClickWA(e){
    const img = e.target.closest('img.wa, img[alt="WhatsApp"]');
    if(!img) return;
    e.preventDefault(); e.stopPropagation();
    const card = img.closest('.order-card');
    const idx = card && card.getAttribute('data-idx');
    const o = (window.__ORDERS || [])[idx] || {};
    const phone = sanitizePhone(o["Phone Number"]) || sanitizePhone(o["Alternate Phone Number"]);
    const msg = buildWhatsAppText(o);
    const url = phone ? "https://wa.me/"+phone+"?text="+encodeURIComponent(msg)
                      : "https://wa.me/?text="+encodeURIComponent(msg);
    if(/Mobi|Android/i.test(navigator.userAgent)){
      location.href = url;
    }else{
      const win = window.open(url, "_blank"); if(!win) location.href = url;
    }
  }
  document.addEventListener('click', onClickWA, true);
})();
</script>

</body>
</html>
