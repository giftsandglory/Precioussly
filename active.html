<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Orders from Google Sheet → Full-Height Popup</title>
<style>
  :root{
    --bg:#f6f7fb; --surface:#fff; --muted:#8a8f98; --ink:#121417; --accent:#2b6df6;
    --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.12); --pad:clamp(10px,2.2vh,16px);
  }
  *{ -webkit-tap-highlight-color:transparent; user-select:none; box-sizing:border-box; }
  html,body{ margin:0; background:var(--bg);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    color:var(--ink);
  }

  .wrap{ min-height:100dvh; padding:20px 16px 40px; display:flex; justify-content:center; }
  .list{ width:clamp(320px, 92vw, 720px); display:grid; gap:16px; }

  .order-card{
    background:var(--surface); border-radius:var(--radius); box-shadow:0 6px 20px rgba(0,0,0,.08);
    padding:18px 20px; cursor:pointer; transition:.25s ease;
  }
  .order-card:hover{ transform:translateY(-1px) }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:16px; color:#6f757d; font-weight:600; letter-spacing:.02em; font-size:14px; }
  .name{ margin:.45rem 0 0 0; font-size:clamp(22px,3.5vw,30px); font-weight:800; }
  .item{ margin:.15rem 0 0 0; font-size:clamp(14px,2.7vw,18px); color:#7a8088; font-style:italic; }
  .amt{ margin-top:.5rem; font-size:clamp(22px,3.6vw,32px); font-weight:800; color:var(--accent); }

  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:var(--pad);
    background:rgba(10,14,20,.28); backdrop-filter:blur(6px); z-index:40; }
  .modal.show{ display:flex }

  .sheet{
    background:var(--surface); border-radius:22px; width:min(96vw, 980px);
    height:calc(100dvh - (var(--pad) * 2)); max-height:100dvh; box-shadow:var(--shadow);
    display:flex; flex-direction:column; overflow:hidden;
  }
  .sheet-header{ padding:14px 18px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eef0f4; }
  .sheet-title{ font-weight:800; letter-spacing:.02em; }
  .close{ display:grid; place-items:center; width:38px; height:38px; border-radius:12px; border:1px solid #e8eaf0; background:#f6f7fb; cursor:pointer; }
  .close:active{ transform:scale(.96) }
  .sheet-body{ flex:1; overflow:auto; padding:14px 18px 18px; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action:pan-y; }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width:760px){ .grid{ grid-template-columns:1fr; } }
  .field{ padding:12px; border:1px solid #eef0f4; border-radius:14px; background:#fff; }
  .label{ font-size:12px; color:var(--muted); letter-spacing:.03em; margin-bottom:6px; font-weight:700; }
  .value{ font-size:14.5px; color:#252a31; line-height:1.35; word-break:break-word; user-select:text; }

  .thumbs{ display:flex; gap:8px; flex-wrap:wrap; }
  .thumbs img{ width:76px; height:76px; object-fit:cover; border-radius:10px; border:1px solid #eef0f4; }

  .details{ display:grid; gap:10px; }
  .details .row{ display:block; color:#252a31; font-weight:500; }
  .details .k{ font-size:12px; color:var(--muted); letter-spacing:.03em; font-weight:700; display:block; margin-bottom:4px; }
  .details .v{ font-size:14.5px; }

  .no-scroll{ height:100vh; overflow:hidden; }
  .empty{ opacity:.5; }
</style>
</head>
<body>
  <div class="wrap">
    <div id="orderList" class="list" aria-live="polite"></div>
  </div>

  <div id="modalRoot"></div>

<script>
const SHEET_ID   = "1wfMl8tSlmfVgoSvnFI6gHEDpmvJsF5wdOQdhFowmngo";
const SHEET_NAME = "Sheet1";

async function getSheetRows(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
  const cols = json.table.cols.map(c => (c.label || "").trim());

  const rows = (json.table.rows || []).map(r => {
    const obj = {};
    cols.forEach((h, i) => obj[h] = (r.c[i] && r.c[i].v != null) ? r.c[i].v : "");
    return obj;
  });
  if(rows.length && rows[0]["Order ID"] === "Order ID"){ rows.shift(); }
  return rows.filter(r => r["Order ID"]);
}

const fmtINR = n => isFinite(n) ? new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(n) : "";
const safe = s => (s!==null && s!==undefined && String(s).trim()!=="") ? String(s).trim() : "—";

function normalizeToDate(val){
  if(val===null || val===undefined || val==="") return null;

  if(typeof val === "number"){
    // Google Sheets serial (days since 1899-12-30)
    const ms = Math.round((val - 25569) * 86400) * 1000;
    return new Date(ms);
  }
  const s = String(val).trim();

  // GViz style Date(YYYY,MM,DD,hh,mm,ss)
  const m = s.match(/^Date\\((\\d+),\\s*(\\d+),\\s*(\\d+)(?:,\\s*(\\d+),\\s*(\\d+),\\s*(\\d+))?\\)$/);
  if(m){
    const y = +m[1], mo = +m[2], d = +m[3], hh = +(m[4]||0), mi = +(m[5]||0), ss = +(m[6]||0);
    return new Date(y, mo, d, hh, mi, ss);
  }

  // ISO-like "YYYY-MM-DD HH:mm:ss"
  if(/^\\d{4}-\\d{2}-\\d{2}[ T]\\d{2}:\\d{2}:\\d{2}/.test(s)){
    return new Date(s.replace(" ","T")+("+05:30"));
  }

  // Fallback: native parse
  const t = Date.parse(s);
  return isNaN(t) ? null : new Date(t);
}

function timeFromIST(val){
  const raw = (val===null || val===undefined) ? "" : String(val).trim();

  const d = normalizeToDate(raw);
  if(!d) return raw || "—";
  try{
    return d.toLocaleString("en-IN",{
      timeZone: "Asia/Kolkata",
      year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
    }).replace(","," –");
  }catch(e){
    return "—";
  }
}

const firstOr = (s, alt="") => s ? String(s).split("|")[0].trim() : alt;

function cardHTML(o, idx){
  const orderTime = timeFromIST(o["Order Timestamp (IST)"]);
  const firstItem = safe(firstOr(o['Items (Name × Quantity; pipe-separated)'], ""));
  const totalLabel = safe(o["Order Total (₹)"]);
  const total = isFinite(+totalLabel) ? fmtINR(+totalLabel) : totalLabel;

  return `
  <article class="order-card" data-idx="${idx}" aria-label="Order ${o["Order ID"]}">
    <div class="row">
      <span>ORDER#${o["Order ID"]}</span>
      <span>${orderTime}</span>
    </div>
    <h2 class="name">${safe(o["Customer Name"])}</h2>
    <p class="item">${firstItem || ""}</p>
    <div class="amt">${total}</div>
  </article>`;
}

function modalHTML(o, idx){
  const images = (o["Item Image URLs"] || "").split("|").map(s => s.trim()).filter(Boolean);
  const thumbs = images.map(src => `<a href="${src}" target="_blank" rel="noopener"><img src="${src}" alt=""></a>`).join("");

  const phone = String(o["Phone Number"]||"").replace(/\\D/g,"");
  const waLink = phone ? `https://wa.me/91${phone}` : "";

  const field = (label, value, wide=false) => `
    <div class="field" ${wide ? 'style="grid-column:1/-1"' : ""}>
      <div class="label">${label}</div>
      <div class="value">${safe(value)}</div>
    </div>`;

  const detailsBox = `
  <div class="field" style="grid-column:1/-1">
    <div class="label">Customer Details</div>
    <div class="value">
      <div class="details">
        <div class="row">
          <span class="k">Customer Name</span>
          <span class="v">${safe(o["Customer Name"])}</span>
        </div>
        <div class="row">
          <span class="k">Full Address</span>
          <span class="v">${safe(o["Full Address"])}</span>
        </div>
        <div class="row">
          <span class="k">Phone Number</span>
          <span class="v">${safe(o["Phone Number"])}</span>
        </div>
        <div class="row">
          <span class="k">Alternate Phone Number</span>
          <span class="v">${safe(o["Alternate Phone Number"])}</span>
        </div>
      </div>
    </div>
  </div>`;

  return `
  <div class="modal" id="modal-${idx}" data-idx="${idx}" aria-hidden="true">
    <section class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle-${idx}">
      <header class="sheet-header">
        <div class="sheet-title" id="sheetTitle-${idx}">ORDER DETAILS — #${o["Order ID"]}</div>
        <button class="close" data-close="${idx}" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0b1a2b" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </header>
      <div class="sheet-body">
        <div class="grid">
          ${field("Order ID", o["Order ID"])}
          ${field("Order Timestamp (IST)", timeFromIST(o["Order Timestamp (IST)"]))}

          ${detailsBox}

          ${field("Customer Email", o["Customer Email"])}

          ${field("City", o["City"])}
          ${field("State", o["State"])}

          ${field("Postal Code (Pincode)", o["Postal Code (Pincode)"])}
          ${field("Payment Method (Razorpay / Cash on Delivery)", o["Payment Method (Razorpay / Cash on Delivery)"])}

          ${field("Payment Status (Paid / Unpaid / Prepaid-COD)", o["Payment Status (Paid / Unpaid / Prepaid-COD)"])}
          ${field("Payment Reference (Razorpay Payment ID / COD Reference)", o["Payment Reference (Razorpay Payment ID / COD Reference)"], true)}

          ${field("COD Prepaid Amount (₹)", o["COD Prepaid Amount (₹)"])}
          ${field("COD Charges (₹)", o["COD Charges (₹)"])}

          ${field("Coupon Code", o["Coupon Code"])}
          ${field("Discount Amount (₹)", o["Discount Amount (₹)"])}

          ${field('Delivery Fee (₹ or "Free Delivery")', o['Delivery Fee (₹ or "Free Delivery")'])}
          ${field("Item Count", o["Item Count"])}

          ${field("Items (Name × Quantity; pipe-separated)", o["Items (Name × Quantity; pipe-separated)"], true)}

          <div class="field" style="grid-column:1/-1">
            <div class="label">Item Image URLs</div>
            <div class="value ${images.length? "" : "empty"}">
              ${images.length ? `<div class="thumbs">${thumbs}</div>` : "—"}
            </div>
          </div>

          ${field("Subtotal (₹)", o["Subtotal (₹)"])}
          ${field("Order Total (₹)", o["Order Total (₹)"])}
        </div>

        ${waLink ? `
          <div style="margin-top:16px">
            <a href="${waLink}" target="_blank" rel="noopener" style="text-decoration:none">
              <span class="value" style="display:inline-flex;align-items:center;gap:8px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#25D366" aria-hidden="true"><path d="M20.52 3.48A11.9 11.9 0 0 0 12.06 0C5.46 0 .1 5.36.1 11.96c0 2.11.56 4.17 1.62 5.99L0 24l6.2-1.64a11.92 11.92 0 0 0 5.86 1.51h.01c6.6 0 11.96-5.36 11.96-11.96 0-3.2-1.25-6.2-3.47-8.43zM12.06 21.9h-.01a9.93 9.93 0 0 1-5.06-1.39l-.36-.21-3.68.97.98-3.59-.24-.37A9.95 9.95 0 0 1 2.13 11.96C2.13 6.48 6.58 2.03 12.06 2.03c2.66 0 5.16 1.04 7.04 2.93a9.89 9.89 0 0 1 2.92 7.01c0 5.48-4.45 9.93-9.96 9.93zm5.74-7.44c-.31-.16-1.83-.9-2.11-1.01-.28-.1-.49-.16-.7.16-.21.31-.8 1-.98 1.2-.18.2-.36.22-.67.06-.31-.16-1.31-.48-2.49-1.53a9.26 9.26 0 0 1-1.72-2.13c-.18-.31 0-.48.14-.64.14-.15.31-.39.47-.59.16-.2.21-.35.31-.59.1-.24.05-.44-.02-.61-.06-.16-.7-1.7-.96-2.32-.25-.6-.5-.52-.7-.53l-.6-.01c-.2 0-.52.07-.8.39-.28.31-1.06 1.04-1.06 2.54 0 1.49 1.09 2.94 1.25 3.15.16.2 2.14 3.28 5.19 4.6.73.32 1.3.51 1.75.66.74.24 1.42.21 1.95.13.59-.09 1.83-.75 2.09-1.48.26-.73.26-1.35.18-1.48-.08-.13-.28-.21-.59-.37z"/></svg>
                Message on WhatsApp
              </span>
            </a>
          </div>` : ``}
      </div>
    </section>
  </div>`;
}

function attachCardHandlers(){
  document.querySelectorAll(".order-card").forEach(card=>{
    card.addEventListener("click", ()=>{
      const idx = card.getAttribute("data-idx");
      const modal = document.getElementById(`modal-${idx}`);
      if(modal){ 
        modal.classList.add("show"); 
        modal.setAttribute("aria-hidden","false");
        document.body.classList.add("no-scroll"); 
      }
    });
  });
  document.querySelectorAll("[data-close]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = btn.getAttribute("data-close");
      closeModal(idx);
    });
  });
  document.querySelectorAll(".modal").forEach(m=>{
    m.addEventListener("click", (e)=>{ if(e.target === m){ closeModal(m.getAttribute("data-idx")); }});
  });
  document.addEventListener("keydown", (e)=>{ 
    if(e.key === "Escape"){ 
      document.querySelectorAll(".modal.show").forEach(m=>m.classList.remove("show")); 
      document.body.classList.remove("no-scroll"); 
    }
  });
}
function closeModal(idx){
  const m = document.getElementById(`modal-${idx}`);
  if(m){ 
    m.classList.remove("show"); 
    m.setAttribute("aria-hidden","true");
    document.body.classList.remove("no-scroll"); 
  }
}

async function main(){
  try{
    const rows = await getSheetRows();
    const list = document.getElementById("orderList");
    const modalRoot = document.getElementById("modalRoot");

    if(!rows.length){
      list.innerHTML = `<div class="order-card empty">No orders in the sheet.</div>`;
      return;
    }

    list.innerHTML = rows.map((o, i) => cardHTML(o, i)).join("");
    modalRoot.innerHTML = rows.map((o, i) => modalHTML(o, i)).join("");
    attachCardHandlers();
  }catch(err){
    console.error(err);
    document.getElementById("orderList").innerHTML =
      `<div class="order-card empty">Could not load the Google Sheet. Check sharing & Sheet name.</div>`;
  }
}
main();
</script>
</body>
</html>
