<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Precioussly</title>
<style>
  :root{
    --bg:#0b0e13;
    --surface:#141824;
    --surface-2:#1a2030;
    --text:#e8ecf3;
    --muted:#9aa4b2;
    --brand:#67b3ff;
    --brand-2:#8b7bff;
    --accent:#22c55e;
    --danger:#ff5d6c;
    --border:rgba(255,255,255,0.08);
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 50% -200px, #1c2541 0%, #0b0e13 60%);
    color:var(--text);
    font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-font-smoothing:antialiased;
    -webkit-tap-highlight-color: transparent;
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:center;
    padding:8px 12px;
    background:linear-gradient(180deg, rgba(10,13,20,.95), rgba(10,13,20,.75));
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .title{
    font-weight:800; letter-spacing:.2px;
    font-size:20px; background:linear-gradient(90deg,var(--brand),var(--brand-2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    margin:6px 0;
  }
  .emoji-btn{
    position:absolute; right:12px; top:8px;
    font-size:22px; line-height:1;
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 10px;
    box-shadow:var(--shadow);
    cursor:pointer; user-select:none;
    transform: translateZ(0);
  }
  .emoji-btn:active{ transform:scale(.98) }
  /* Quick Sign-in button (top-left) */
.signin-btn{
  position:absolute; left:12px; top:8px;
  font-size:13px; font-weight:800;
  background:#0e1423;
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 12px;
  box-shadow:var(--shadow);
  color:#cfe1ff;
  cursor:pointer; user-select:none;
}
.signin-btn.authed{
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  color:#0b0e13; border:none;
}
.signin-btn:active{ transform:scale(.98) }

  /* Tabs bar (sheet tabs) */
  .tabs{
    position:sticky; top:52px; z-index:40;
    display:flex; gap:8px; overflow:auto; padding:10px 12px 4px;
    background:linear-gradient(180deg, rgba(10,13,20,.85), rgba(10,13,20,0));
    scrollbar-width:none;
  }
  .tabs::-webkit-scrollbar{ display:none }
  .tab-chip{
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--surface);
    color:var(--muted);
    white-space:nowrap; cursor:pointer;
  }
  .tab-chip.active{ background:linear-gradient(90deg,#1f2840,#111728); color:var(--text); border-color:#2a3655 }

  /* List cards */
  .list{ padding:10px 10px 100px; }
  .card{
    background:linear-gradient(180deg,#121826,#0f1422);
    border:1px solid var(--border);
    border-radius:16px;
    padding:10px 12px;
    margin:10px auto;
    max-width:820px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
    transition:transform .12s ease, background .2s ease;
    touch-action: manipulation;
  }
  .thumb-mini{
    flex:0 0 68px; height:68px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#0f1625;
  }
  .thumb-mini img{ width:100%; height:100%; object-fit:cover; display:block; }
  .card:hover{ transform: translateY(-1px); }
  .card h4{ margin:0 0 2px 0; font-size:16px; font-weight:800; color:#d7e6ff; }
  .sub{ color:var(--muted); font-size:12px; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border); background:#0e1525; color:#cfe1ff; }
  .chip.badge{ background:linear-gradient(135deg,#fceabb,#f8b500); color:#231b00; border:none; font-weight:800; }
  .chip.hide{ background:#26131a; color:#ffd7de; border-color:#5a1f2c; }
  .price{ text-align:right; margin-left:auto; }
  .price .sell{ font-weight:900; font-size:18px; color:#b4ffcb; }
  .price .mrp{ color:#97a1b3; text-decoration:line-through; font-size:12px; display:block; }
  .rightbox{ display:flex; align-items:center; gap:8px; margin-left:auto; }
  .open-btn{
    padding:8px 12px; border-radius:10px;
    border:1px solid var(--border);
    background:#111827; color:#bcd0ff; font-weight:700; cursor:pointer;
  }

  /* Reorder controls (shown on long press) */
  .reorder{ display:none; gap:8px; }
  .rbtn{
    width:36px; height:36px; border-radius:999px;
    border:1px solid var(--border); background:#0f1625; color:#c7d2fe;
    display:grid; place-items:center; font-size:18px; cursor:pointer;
  }
  .card.reorder-mode .reorder{ display:flex; }
  .card.reorder-mode .open-btn{ display:none; }

  /* Floating add button */
  .fab{
    position:fixed; right:14px; bottom:16px; z-index:45;
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center;
    background:linear-gradient(135deg,var(--brand-2),var(--brand));
    color:#0b0e13; font-size:24px; font-weight:900;
    box-shadow:var(--shadow);
    border:none; cursor:pointer;
  }

  /* Modal base */
  .modal{
    position:fixed; inset:0; display:none; z-index:60;
    background:rgba(3,6,12,.6); backdrop-filter: blur(6px);
    align-items:center; justify-content:center; padding:20px;
  }
  .modal.show{ display:flex }
  .sheet{
    width:min(760px, 96vw);
    max-height:86vh; overflow:auto;
    background:linear-gradient(180deg,#121827,#0f1524);
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow:var(--shadow);
    animation:pop .2s ease;
  }
  @keyframes pop{ from{ opacity:0; transform: translateY(6px) scale(.98);} to{opacity:1; transform:none;} }

  .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .row.two{ grid-template-columns: 1fr 1fr; }
  label{ color:var(--muted); font-size:12px; }
  input,textarea,select{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid #243049; background:#0f1625; color:var(--text);
    outline:none;
  }
  input:focus,textarea:focus,select:focus{ border-color:#364a74; }
  .btn{
    padding:10px 14px; border-radius:10px;
    border:1px solid var(--border); background:#0f1625; color:#fff;
    cursor:pointer;
  }
  .btn.primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#0b0e13; border:none; font-weight:800; }
  .btn.danger{ background: #2a0f15; border-color:#501b24; color:#ffb4bd; }
  .btn.ghost{ background:#0e1423 }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; }

  /* Hide blue highlight on Android */
  a, button, input, select, textarea { -webkit-tap-highlight-color: transparent; }

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#0e1624; border:1px solid #25314b; color:#cfe1ff;
    padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); display:none; z-index:80;
  }
  .toast.show{ display:block }

  /* Image manager */
  .imgmgr{ border:1px dashed #2a3550; padding:10px; border-radius:12px; background:#0c1322; }
  .imgmgr .rowline{ display:flex; gap:8px; margin-bottom:8px; }
  .imgmgr input.url{ flex:1; }
  .thumbs{ display:flex; flex-wrap:wrap; gap:10px; }
  .thumb{
    position:relative; width:76px; height:76px; border-radius:10px; overflow:hidden;
    border:1px solid #243049; background:#0f1625;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .thumb .ctrls{ position:absolute; inset:auto 4px 4px 4px; display:flex; gap:4px; justify-content:space-between; }
  .thumb button{
    border:none; background:rgba(10,15,25,.7); color:#cfe1ff; padding:4px 6px; border-radius:8px; font-size:12px; cursor:pointer;
  }
</style>
</head>
<body>
  
  <div class="topbar">
  <!-- NEW: quick sign-in button (left corner) -->
  <button class="signin-btn" id="quickSignInBtn" title="Sign in">Sign in</button>

  <div class="title">Precioussly</div>
  <button class="emoji-btn" id="settingsBtn" title="Settings">ðŸ˜Ž</button>
</div>

  <div id="tabs" class="tabs" style="display:none;"></div>

  <div id="list" class="list"></div>

  <button class="fab" id="addBtn" title="Add item">ï¼‹</button>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="sheet">
      <h3 style="margin:6px 4px 10px">Connect Google Sheet</h3>
      <div class="row">
        <div>
          <label>Google Sheet Link</label>
          <input id="sheetLink" placeholder="Paste Google Sheet URL here">
        </div>
      </div>
      <div class="row two">
        <div>
          <label>Add Tab Name</label>
          <div style="display:flex; gap:8px;">
            <input id="tabName" placeholder="e.g. Sheet1">
            <button class="btn" id="addTabBtn">Add</button>
          </div>
        </div>
        <div>
          <label>Active Tab</label>
          <select id="activeTabSelect"></select>
        </div>
      </div>

      <div class="actions" style="margin-top:8px">
        <button class="btn primary" id="fetchBtn">Fetch from Active Tab</button>
        <button class="btn ghost" id="demoBtn">Load Demo Data</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--border); margin:14px 0">

      <details>
        <summary class="sub" style="cursor:pointer">Optional: Enable editing back to Google Sheets (needs API Key & OAuth Client ID)</summary>
        <div class="row two" style="margin-top:8px">
          <div>
            <label>Google API Key</label>
            <input id="apiKey" placeholder="AIza...">
          </div>
          <div>
            <label>OAuth Client ID</label>
            <input id="clientId" placeholder="xxxx.apps.googleusercontent.com">
          </div>
        </div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" id="signinBtn">Sign in (enable save)</button>
          <button class="btn danger" id="signoutBtn">Sign out</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="sheet">
      <h3 id="editTitleText" style="margin:6px 4px 10px">Edit Item</h3>
      <div id="editFields" class="row"></div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="saveItemBtn">Save Changes</button>
        <button class="btn danger" id="deleteItemBtn">Delete</button>
        <button class="btn" id="cancelEditBtn">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    sheetId: "",
    tabs: [],
    activeTab: "",
    headers: [],
    rows: [],
    apiKey: "AIzaSyCnzxctSVV_-bKRGox0tgGo2M_ajPONzbE",
    clientId: "746848628668-30i7srbj2o3ft2duikoeno9a6b98aadi.apps.googleusercontent.com",
    authEnabled: false,
    tokenClient: null
  };

  const toast = (msg) => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  };
// ðŸ‘‡ Helper to extract readable API errors
const errorText = (e) => {
  try {
    return (e && (e.result?.error?.message || e.message || e.statusText)) || "Unknown error";
  } catch (_) { return "Unknown error"; }
};
  const parseSheetId = (link) => {
    try {
      const m = link.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return m ? m[1] : "";
    } catch(e){ return ""; }
  };

  const saveLocal = () => {
    localStorage.setItem("prec.sheet", JSON.stringify({
      sheetId: state.sheetId,
      tabs: state.tabs,
      activeTab: state.activeTab,
      apiKey: state.apiKey,
      clientId: state.clientId
    }));
  };
  const loadLocal = () => {
    try{
      const o = JSON.parse(localStorage.getItem("prec.sheet")||"{}");
      if(o.sheetId) state.sheetId = o.sheetId;
      if(o.tabs) state.tabs = o.tabs;
      if(o.activeTab) state.activeTab = o.activeTab;
      if(o.apiKey) state.apiKey = o.apiKey;
      if(o.clientId) state.clientId = o.clientId;
      renderSettingsFromState();
    }catch(e){}
  };

  /* ---------- Public fetch via GViz ---------- */
  async function fetchGViz(sheetId, tab){
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Fetch failed");
    const txt = await res.text();
    const jsonStr = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
    const obj = JSON.parse(jsonStr);
    const cols = (obj.table.cols||[]).map(c => (c.label||"").trim() || (c.id||""));
    const headers = cols.length ? cols : [];
    const rows = (obj.table.rows||[]).map(r => (r.c||[]).map(cell => cell ? cell.v : ""));
    return { headers, rows };
  }

  /* ---------- Google API auth & read/write ---------- */
  async function initGapi(){
    if(!window.gapi) return;
    await new Promise(resolve => gapi.load('client', resolve));
    await gapi.client.init({
      apiKey: state.apiKey,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    });
  }
  function initGis(){
    if(!window.google || !google.accounts) return;
    state.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: state.clientId,
      scope: "https://www.googleapis.com/auth/spreadsheets",
      callback: (resp) => {
        if(resp.error){
          toast("Sign in failed");
        }else{
          state.authEnabled = true; toast("Editing enabled");
        }
      }
    });
  }
  function signIn(){
    if(!state.clientId || !state.apiKey){ toast("Enter API Key & Client ID first"); return; }
    initGapi().then(()=>{
      initGis();
      if(state.tokenClient){
        state.tokenClient.requestAccessToken({ prompt: "consent" });
      }else{
        toast("GIS init failed");
      }
    });
  }
  function signOut(){
    const tok = gapi.client.getToken();
    if(tok){
      google.accounts.oauth2.revoke(tok.access_token);
      gapi.client.setToken('');
    }
    state.authEnabled = false;
    toast("Signed out");
  }
  // --- NEW: update button UI when auth state changes ---
function markAuthUI(){
  const b = $("#quickSignInBtn");
  if(!b) return;
  if(state.authEnabled){
    b.textContent = "Signed in";
    b.classList.add("authed");
  }else{
    b.textContent = "Sign in";
    b.classList.remove("authed");
  }
}

// --- REQUIRED: ensure we have a Sheets write token set into gapi ---
async function ensureSignedIn(){
  // If already authorized, we're good
  if(state.authEnabled){ markAuthUI(); return true; }

  // Ask user to enter keys if missing
  if(!state.clientId || !state.apiKey){
    openSettings();
    toast("Enter API Key & Client ID first");
    return false;
  }

  // Initialize gapi + GIS
  await initGapi();
  initGis();
  if(!state.tokenClient){ toast("Google sign-in init failed"); return false; }

  // Request an access token and install it into gapi
  return new Promise((resolve) => {
    state.tokenClient.callback = (resp) => {
      if(resp && resp.access_token){
        gapi.client.setToken({ access_token: resp.access_token }); // <â€” critical
        state.authEnabled = true;
        markAuthUI();
        toast("Editing enabled");
        resolve(true);
      }else{
        toast("Sign in failed");
        resolve(false);
      }
    };
    state.tokenClient.requestAccessToken({ prompt: "consent" });
  });
}
  async function writeRowToSheet(index){
    const range = `${state.activeTab}!A${index+2}:${String.fromCharCode(65+state.headers.length-1)}${index+2}`;
    const values = [ state.headers.map(h => state.rows[index][h] ?? "") ];
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: state.sheetId,
      range,
      valueInputOption: "RAW",
      resource: { values }
    });
  }
  async function appendRowToSheet(rowObj){
    const range = `${state.activeTab}!A2:${String.fromCharCode(65+state.headers.length-1)}`;
    const values = [ state.headers.map(h => rowObj[h] ?? "") ];
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: state.sheetId,
      range,
      valueInputOption: "RAW",
      insertDataOption: "INSERT_ROWS",
      resource: { values }
    });
  }
  async function writeAllRowsToSheet(){
    const arr = state.rows.map(row => state.headers.map(h => row[h] ?? ""));
    const range = `${state.activeTab}!A2:${String.fromCharCode(65+state.headers.length-1)}`;
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: state.sheetId,
      range,
      valueInputOption: "RAW",
      resource: { values: arr }
    });
  }

  /* ---------- Render ---------- */
  function renderTabs(){
    const tabsWrap = $("#tabs");
    tabsWrap.innerHTML = "";
    if(!state.tabs.length){ tabsWrap.style.display="none"; return; }
    tabsWrap.style.display = "flex";
    state.tabs.forEach(tab => {
      const el = document.createElement("div");
      el.className = "tab-chip" + (tab===state.activeTab? " active": "");
      el.textContent = tab;
      el.onclick = () => { state.activeTab = tab; saveLocal(); if(state.sheetId) fetchCurrent(); };
      tabsWrap.appendChild(el);
    });
  }

  function getThumb(row){
    const p = Object.keys(row).filter(k => /photo\s*\d+/i.test(k)).sort((a,b)=>{
      const na = parseInt(a.replace(/\D+/g,''))||0, nb = parseInt(b.replace(/\D+/g,''))||0; return na-nb;
    });
    for(const k of p){ if(row[k]) return row[k]; }
    const ci = Object.keys(row).find(k => /image/i.test(k));
    if(ci){
      const parts = String(row[ci]||"").split(/[, \n]+/).filter(Boolean);
      if(parts[0]) return parts[0];
    }
    return "";
  }

  function renderList(){
    const list = $("#list");
    list.innerHTML = "";
    if(!state.rows.length){
      const empty = document.createElement("div");
      empty.style.cssText="text-align:center;color:var(--muted);padding:24px";
      empty.textContent = "No items yet. Tap ï¼‹ to add or use ðŸ˜Ž to connect a sheet.";
      list.appendChild(empty);
      return;
    }
    const titleKey = state.headers.find(h => /product\s*name/i.test(h)) || state.headers[0];
    const sectionKey = state.headers.find(h => /section/i.test(h)) || state.headers[1];
    const badgeKey = state.headers.find(h => /badge/i.test(h));
    const visKey = state.headers.find(h => /visibil/i.test(h));
    const mrpKey = state.headers.find(h => /mrp/i.test(h));
    const spKey = state.headers.find(h => /selling\s*price/i.test(h));

    state.rows.forEach((row, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.index = idx;

      const thumb = document.createElement("div");
      thumb.className = "thumb-mini";
      const timg = document.createElement("img");
      const tsrc = getThumb(row);
      if(tsrc){ timg.src = tsrc; } else { timg.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect fill='%23131a2a' x='0' y='0' width='100%' height='100%'/></svg>"; }
      thumb.appendChild(timg);

      const mid = document.createElement("div");
      mid.style.flex="1";
      mid.innerHTML = `<h4>${escapeHtml(row[titleKey]||"Untitled")}</h4>
                       <div class="sub">${escapeHtml(row[sectionKey]||"")}</div>`;
      const chips = document.createElement("div"); chips.className = "chips";
      if(badgeKey && row[badgeKey]){
        const chip = document.createElement("span"); chip.className="chip badge"; chip.textContent = row[badgeKey];
        chips.appendChild(chip);
      }
      if(visKey && String(row[visKey]).toLowerCase().includes("hide")){
        const chip = document.createElement("span"); chip.className="chip hide"; chip.textContent = "Hidden";
        chips.appendChild(chip);
      }
      mid.appendChild(chips);

      const right = document.createElement("div"); right.className="rightbox";
      const price = document.createElement("div"); price.className="price";
      if(spKey && row[spKey]){
        price.innerHTML = `<span class="sell">â‚¹${escapeHtml(row[spKey])}</span>`;
        if(mrpKey && row[mrpKey]){
          price.innerHTML += `<span class="mrp">MRP â‚¹${escapeHtml(row[mrpKey])}</span>`;
        }
      }
      const openBtn = document.createElement("button");
      openBtn.className = "open-btn"; openBtn.textContent = "Open";
      openBtn.onclick = (e)=>{ e.stopPropagation(); openEditor(idx); };

      const reorderWrap = document.createElement("div");
      reorderWrap.className="reorder";
      const up = document.createElement("button"); up.className="rbtn"; up.textContent="â–²";
      const down = document.createElement("button"); down.className="rbtn"; down.textContent="â–¼";
      up.onclick = (e)=>{ e.stopPropagation(); moveItem(idx, -1); };
      down.onclick = (e)=>{ e.stopPropagation(); moveItem(idx, 1); };
      reorderWrap.appendChild(up); reorderWrap.appendChild(down);

      right.appendChild(price);
      right.appendChild(reorderWrap);
      right.appendChild(openBtn);

      let pressTimer;
      const start = () => { pressTimer = setTimeout(()=>{ card.classList.add("reorder-mode"); }, 400); };
      const cancel = () => { clearTimeout(pressTimer); };
      card.addEventListener("touchstart", start, {passive:true});
      card.addEventListener("touchend", cancel);
      card.addEventListener("touchmove", cancel);
      card.addEventListener("mousedown", start);
      card.addEventListener("mouseup", cancel);
      card.addEventListener("mouseleave", cancel);

      card.onclick = ()=> openEditor(idx);

      card.appendChild(thumb);
      card.appendChild(mid);
      card.appendChild(right);
      list.appendChild(card);
    });
  }

  function renderSettingsFromState(){
    $("#sheetLink").value = state.sheetId ? `https://docs.google.com/spreadsheets/d/${state.sheetId}/edit` : "";
    $("#apiKey").value = state.apiKey || "";
    $("#clientId").value = state.clientId || "";
    const select = $("#activeTabSelect");
    select.innerHTML = "";
    state.tabs.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t; opt.textContent = t;
      if(t===state.activeTab) opt.selected = true;
      select.appendChild(opt);
    });
    renderTabs();
  }

  function openSettings(){ $("#settingsModal").classList.add("show"); }
  function closeSettings(){ $("#settingsModal").classList.remove("show"); }

  /* -------- Image Manager helpers (supports 'photo 1..4' group or individual 'image' fields) -------- */
  function parseImages(str){
    if(!str) return [];
    return String(str).split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  }
  function imagesToString(arr){ return arr.join(", "); }
  function buildImageManager(initial, onChange){
    const wrap = document.createElement("div");
    wrap.className = "imgmgr";
    let imgs = [...initial];

    const rowline = document.createElement("div");
    rowline.className = "rowline";
    const urlInput = document.createElement("input");
    urlInput.className = "url";
    urlInput.placeholder = "Paste image URL and press Add";
    const addBtn = document.createElement("button");
    addBtn.className = "btn";
    addBtn.textContent = "Add";
    rowline.appendChild(urlInput); rowline.appendChild(addBtn);

    const thumbs = document.createElement("div");
    thumbs.className = "thumbs";

    function renderThumbs(){
      thumbs.innerHTML = "";
      imgs.forEach((u, i) => {
        const th = document.createElement("div");
        th.className = "thumb";
        const img = document.createElement("img");
        img.src = u; img.alt = "img";
        const ctrls = document.createElement("div");
        ctrls.className = "ctrls";
        const up = document.createElement("button"); up.textContent = "â–²";
        const down = document.createElement("button"); down.textContent = "â–¼";
        const del = document.createElement("button"); del.textContent = "âœ•";
        up.onclick = () => { if(i>0){ const t=imgs[i-1]; imgs[i-1]=imgs[i]; imgs[i]=t; changed(); } };
        down.onclick = () => { if(i<imgs.length-1){ const t=imgs[i+1]; imgs[i+1]=imgs[i]; imgs[i]=t; changed(); } };
        del.onclick = () => { imgs.splice(i,1); changed(); };
        ctrls.appendChild(up); ctrls.appendChild(down); ctrls.appendChild(del);
        th.appendChild(img); th.appendChild(ctrls);
        thumbs.appendChild(th);
      });
    }
    function changed(){ renderThumbs(); onChange(imgs); }

    addBtn.onclick = () => {
      const v = urlInput.value.trim();
      if(!v) return;
      imgs.push(v); urlInput.value=""; changed();
    };

    wrap.appendChild(rowline);
    wrap.appendChild(thumbs);
    renderThumbs();
    return {el: wrap, get: ()=>imgs.slice(), set: (arr)=>{ imgs = arr.slice(); renderThumbs(); } };
  }

  
  function openEditor(index){
    const isNew = (index === -1);
    $("#editTitleText").textContent = isNew ? "Add Item" : "Edit Item";
    const fieldsWrap = $("#editFields");
    fieldsWrap.innerHTML = "";
    const row = isNew ? Object.fromEntries(state.headers.map(h=>[h,""])) : {...state.rows[index]};

    // Status badge
    const titleEl = $("#editTitleText");
    let badge = document.getElementById("autoSaveBadge");
    if(badge) badge.remove();
    badge = document.createElement("span");
    badge.id = "autoSaveBadge";
    badge.className = "sub";
    badge.style.marginLeft = "10px";
    badge.style.fontSize = "12px";
    badge.textContent = isNew ? "Auto-save: off for new item" : (state.authEnabled ? "Auto-save: ON" : "Auto-save: Sign in");
    titleEl.appendChild(badge);

    // Group photo fields
    const photoFields = state.headers.filter(h => /photo\s*\d+/i.test(h)).sort((a,b)=>{
      const na = parseInt(a.replace(/\D+/g,''))||0, nb = parseInt(b.replace(/\D+/g,''))||0; return na-nb;
    });
    const handled = new Set();
    let photoMgr = null, photoMgrFields = [];

    if(photoFields.length){
      const lbl = document.createElement("label"); lbl.textContent = "Photos (supports multiple URLs)";
      const initial = photoFields.map(h => row[h]).filter(Boolean);
      const mgr = buildImageManager(initial, (arr)=>{
        // write back to row & auto-save
        for(let i=0;i<photoFields.length;i++){ row[photoFields[i]] = arr[i] || ""; }
        autoSave();
      });
      photoMgr = mgr;
      photoMgrFields = photoFields.slice();
      const box = document.createElement("div"); box.appendChild(lbl); box.appendChild(mgr.el);
      fieldsWrap.appendChild(box);
      photoFields.forEach(h => handled.add(h));
    }

    // Build remaining fields
    state.headers.forEach(h => {
      if(handled.has(h)) return;
      if(/image/i.test(h) && !/photo/i.test(h)){
        const lbl = document.createElement("label"); lbl.textContent = h + " (supports multiple URLs)";
        const mgr = buildImageManager(parseImages(row[h]||""), (arr)=>{ row[h] = arr.join(", "); autoSave(); });
        const box = document.createElement("div"); box.appendChild(lbl); box.appendChild(mgr.el);
        fieldsWrap.appendChild(box);
      }else{
        const f = document.createElement("div");
        f.innerHTML = `<label>${escapeHtml(h)}</label><input data-key="${escapeHtml(h)}" value="${escapeHtml(row[h] ?? "")}">`
        fieldsWrap.appendChild(f);
      }
    });

    const autoSave = debounce(async () => {
      if(isNew) return; // avoid creating phantom rows
      if(!state.authEnabled){ badge.textContent = "Auto-save: Sign in"; return; }
      try{
        badge.textContent = "Saving...";
        state.rows[index] = row;
        await writeRowToSheet(index);
        badge.textContent = "Saved âœ“";
      }catch(e){
        badge.textContent = "Save failed";
      }
    }, 700);

    // Wire change listeners
    Array.from(fieldsWrap.querySelectorAll("input[data-key]"))
      .forEach(i => i.addEventListener("input", () => { row[i.dataset.key] = i.value; autoSave(); }));

    $("#editModal").classList.add("show");

    // Proactively sign-in so auto-save works without extra clicks
    if(!state.authEnabled){
      ensureSignedIn().then(ok => { if(ok && !isNew) badge.textContent = "Auto-save: ON"; });
    }

    // Save / Delete / Cancel
    $("#saveItemBtn").onclick = async () => {
      // Collect text inputs again
      Array.from(fieldsWrap.querySelectorAll("input[data-key]"))
        .forEach(i => row[i.dataset.key] = i.value);

      // Sync photo manager back into "photo n" columns (if present)
      if(photoMgr && photoMgrFields.length){
        const arr = photoMgr.get();
        for(let i=0;i<photoMgrFields.length;i++){ row[photoMgrFields[i]] = arr[i] || ""; }
      }

      if(isNew){
        // For new items, append once on Save
        const ok = state.authEnabled || await ensureSignedIn();
        if(!ok) return;
        state.rows.push(row);
        try{
          await appendRowToSheet(row);
          toast("Added to Sheet");
        }catch(e){
          toast("Add failed: " + errorText(e));
        }
      }else{
        // Final explicit save (in case user turned off auto or was offline)
        try{
          state.rows[index] = row;
          await writeRowToSheet(index);
          toast("Saved to Sheet");
        }catch(e){
          toast("Save failed (check API/permission)");
        }
      }
      renderList();
      closeEditor();
    };

    $("#deleteItemBtn").onclick = async () => {
      if(!confirm("Delete this item?")) return;
      const ok = state.authEnabled || await ensureSignedIn();
      if(!ok) return;
      if(index >= 0 && index < state.rows.length){
        state.rows.splice(index,1);
      }
      try{
        await writeAllRowsToSheet();
        toast("Deleted in Sheet");
      }catch(e){
        toast("Delete failed (check API/permission)");
      }
      renderList();
      closeEditor();
    };

    $("#cancelEditBtn").onclick = closeEditor;
  }

  function closeEditor(){ $("#editModal").classList.remove("show"); }

  async function moveItem(index, dir){
  const newIdx = index + dir;
  if(newIdx<0 || newIdx>=state.rows.length) return;
  const item = state.rows.splice(index,1)[0];
  state.rows.splice(newIdx,0,item);
  renderList();

  const ok = await ensureSignedIn();
  if(!ok){ toast("Reordered locally (sign in to save)"); return; }

  try{
    await writeAllRowsToSheet();
    toast("Reordered");
  }catch(e){
    toast("Reorder failed (check API/permission)");
  }
}

  function escapeHtml(s){
    return String(s==null?"":s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }

  async function fetchCurrent(){
    if(!state.sheetId || !state.activeTab){ toast("Add sheet link & tab first"); return; }
    try{
      const { headers, rows } = await fetchGViz(state.sheetId, state.activeTab);
      if(!headers.length){
        toast("No headings found (maybe private). Try Sign in.");
        return;
      }
      state.headers = headers;
      state.rows = rows.map(r => {
        const obj = {};
        headers.forEach((h,i)=> obj[h] = r[i] ?? "");
        return obj;
      });
      renderList();
      toast(`Loaded ${state.rows.length} rows from ${state.activeTab}`);
    }catch(e){
      toast("Fetch failed. If sheet is private, enable editing and Sign in.");
    }
  }

  /* ---------- Event bindings ---------- */
  $("#settingsBtn").onclick = () => { openSettings(); };
  $("#fetchBtn").onclick = async () => {
    const id = parseSheetId($("#sheetLink").value.trim());
    if(!id) return toast("Invalid sheet link");
    state.sheetId = id;
    const activeSel = $("#activeTabSelect");
    state.activeTab = activeSel.value || state.tabs[0] || "";
    saveLocal(); renderTabs(); closeSettings();
    fetchCurrent();
  };
  $("#addTabBtn").onclick = () => {
    const name = $("#tabName").value.trim();
    if(!name) return;
    if(!state.tabs.includes(name)) state.tabs.push(name);
    if(!state.activeTab) state.activeTab = name;
    $("#tabName").value = "";
    saveLocal(); renderSettingsFromState(); renderTabs();
  };
  $("#activeTabSelect").onchange = (e)=>{ state.activeTab = e.target.value; saveLocal(); };
  $("#demoBtn").onclick = ()=>{
    // HEADERS based on your screenshots
    state.headers = ["Box Direction","Section","Product Name","visibility","Description","Badge","photo 1","photo 2","photo 3","photo 4","MRP","Selling Price","in stock","google sheet","tab name"];
    // DEMO ROWS resembling your sheet
    state.rows = [
      {
        "Box Direction":"",
        "Section":"Car Keychains",
        "Product Name":"car Keychain",
        "visibility":"",
        "Description":"",
        "Badge":"Bestseller",
        "photo 1":"https://i.postimg.cc/fk4627NT/IMG-20250629-004309.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"80",
        "Selling Price":"75",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      },
      {
        "Box Direction":"",
        "Section":"",
        "Product Name":"Red",
        "visibility":"hide",
        "Description":"",
        "Badge":"",
        "photo 1":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"15",
        "Selling Price":"10",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      },
      {
        "Box Direction":"",
        "Section":"",
        "Product Name":"blue",
        "visibility":"hide",
        "Description":"",
        "Badge":"",
        "photo 1":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"18",
        "Selling Price":"10",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      },
      {
        "Box Direction":"",
        "Section":"",
        "Product Name":"green",
        "visibility":"hide",
        "Description":"",
        "Badge":"",
        "photo 1":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"15",
        "Selling Price":"10",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      },
      {
        "Box Direction":"",
        "Section":"Ribbon",
        "Product Name":"white",
        "visibility":"",
        "Description":"",
        "Badge":"",
        "photo 1":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"100",
        "Selling Price":"10",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      },
      {
        "Box Direction":"",
        "Section":"",
        "Product Name":"yellow",
        "visibility":"",
        "Description":"",
        "Badge":"Bestseller",
        "photo 1":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"100",
        "Selling Price":"50",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      },
      {
        "Box Direction":"",
        "Section":"",
        "Product Name":"gray",
        "visibility":"",
        "Description":"",
        "Badge":"",
        "photo 1":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg",
        "photo 2":"",
        "photo 3":"",
        "photo 4":"",
        "MRP":"100",
        "Selling Price":"50",
        "in stock":"10",
        "google sheet":"https://docs.google.com/spreadsheets/d/1PFz3c1VNcmFo5NkN1xdpCyYxJJGxMlxt1Aw_tWv56nA/edit?usp=drivesdk",
        "tab name":"Sheet1"
      }
    ];
    renderList();
    closeSettings();
    toast("Premium demo loaded");
  };

  $("#addBtn").onclick = ()=>{
    if(!state.headers.length){
      state.headers = ["Box Direction","Section","Product Name","visibility","Description","Badge","photo 1","photo 2","photo 3","photo 4","MRP","Selling Price","in stock","google sheet","tab name"];
    }
    openEditor(-1);
  };

  $("#signinBtn").onclick = async () => {
  state.apiKey = $("#apiKey").value.trim();
  state.clientId = $("#clientId").value.trim();
  saveLocal();
  await ensureSignedIn();
};
$("#quickSignInBtn").onclick = async () => {
  const ok = await ensureSignedIn();
  // After sign-in, if a sheet & tab are set, load it immediately
  if(ok && state.sheetId && state.activeTab) fetchCurrent();
};
  $("#signoutBtn").onclick = () => { signOut(); markAuthUI(); };

  $$(".modal").forEach(m => m.addEventListener("click",(e)=>{
    if(e.target.classList.contains("modal")) e.target.classList.remove("show");
  }));

  loadLocal();
  renderList();
  markAuthUI();
})();
</script>
</body>
</html>
