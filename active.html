<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Precioussly</title>
<style>
  :root{
    --bg:#0b0e13;
    --surface:#141824;
    --surface-2:#1a2030;
    --text:#e8ecf3;
    --muted:#9aa4b2;
    --brand:#67b3ff;
    --brand-2:#8b7bff;
    --accent:#22c55e;
    --danger:#ff5d6c;
    --border:rgba(255,255,255,0.08);
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 50% -200px, #1c2541 0%, #0b0e13 60%);
    color:var(--text);
    font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-font-smoothing:antialiased;
    -webkit-tap-highlight-color: transparent;
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:center;
    padding:8px 12px;
    background:linear-gradient(180deg, rgba(10,13,20,.95), rgba(10,13,20,.75));
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .title{
    font-weight:800; letter-spacing:.2px;
    font-size:20px; background:linear-gradient(90deg,var(--brand),var(--brand-2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    margin:6px 0;
  }
  .emoji-btn{
    position:absolute; right:12px; top:8px;
    font-size:22px; line-height:1;
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 10px;
    box-shadow:var(--shadow);
    cursor:pointer; user-select:none;
    transform: translateZ(0);
  }
  .emoji-btn:active{ transform:scale(.98) }

  /* Tabs bar (sheet tabs) */
  .tabs{
    position:sticky; top:52px; z-index:40;
    display:flex; gap:8px; overflow:auto; padding:10px 12px 4px;
    background:linear-gradient(180deg, rgba(10,13,20,.85), rgba(10,13,20,0));
    scrollbar-width:none;
  }
  .tabs::-webkit-scrollbar{ display:none }
  .tab-chip{
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--surface);
    color:var(--muted);
    white-space:nowrap; cursor:pointer;
  }
  .tab-chip.active{ background:linear-gradient(90deg,#1f2840,#111728); color:var(--text); border-color:#2a3655 }

  /* List cards */
  .list{ padding:10px 10px 100px; }
  .card{
    background:linear-gradient(180deg,#121826,#0f1422);
    border:1px solid var(--border);
    border-radius:16px;
    padding:10px 12px;
    margin:10px auto;
    max-width:820px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
    transition:transform .12s ease, background .2s ease;
    touch-action: manipulation;
  }
  .thumb-mini{
    flex:0 0 68px; height:68px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#0f1625;
  }
  .thumb-mini img{ width:100%; height:100%; object-fit:cover; display:block; }
  .card:hover{ transform: translateY(-1px); }
  .card h4{ margin:0 0 2px 0; font-size:16px; font-weight:800; color:#d7e6ff; }
  .sub{ color:var(--muted); font-size:12px; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border); background:#0e1525; color:#cfe1ff; }
  .chip.badge{ background:linear-gradient(135deg,#fceabb,#f8b500); color:#231b00; border:none; font-weight:800; }
  .chip.hide{ background:#26131a; color:#ffd7de; border-color:#5a1f2c; }
  .price{ text-align:right; margin-left:auto; }
  .price .sell{ font-weight:900; font-size:18px; color:#b4ffcb; }
  .price .mrp{ color:#97a1b3; text-decoration:line-through; font-size:12px; display:block; }
  .rightbox{ display:flex; align-items:center; gap:8px; margin-left:auto; }
  .open-btn{
    padding:8px 12px; border-radius:10px;
    border:1px solid var(--border);
    background:#111827; color:#bcd0ff; font-weight:700; cursor:pointer;
  }

  /* Reorder controls (shown on long press) */
  .reorder{ display:none; gap:8px; }
  .rbtn{
    width:36px; height:36px; border-radius:999px;
    border:1px solid var(--border); background:#0f1625; color:#c7d2fe;
    display:grid; place-items:center; font-size:18px; cursor:pointer;
  }
  .card.reorder-mode .reorder{ display:flex; }
  .card.reorder-mode .open-btn{ display:none; }

  /* Floating add button */
  .fab{
    position:fixed; right:14px; bottom:16px; z-index:45;
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center;
    background:linear-gradient(135deg,var(--brand-2),var(--brand));
    color:#0b0e13; font-size:24px; font-weight:900;
    box-shadow:var(--shadow);
    border:none; cursor:pointer;
  }

  /* Modal base */
  .modal{
    position:fixed; inset:0; display:none; z-index:60;
    background:rgba(3,6,12,.6); backdrop-filter: blur(6px);
    align-items:center; justify-content:center; padding:20px;
  }
  .modal.show{ display:flex }
  .sheet{
    width:min(760px, 96vw);
    max-height:86vh; overflow:auto;
    background:linear-gradient(180deg,#121827,#0f1524);
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow:var(--shadow);
    animation:pop .2s ease;
  }
  @keyframes pop{ from{ opacity:0; transform: translateY(6px) scale(.98);} to{opacity:1; transform:none;} }

  .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .row.two{ grid-template-columns: 1fr 1fr; }
  label{ color:var(--muted); font-size:12px; }
  input,textarea,select{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid #243049; background:#0f1625; color:var(--text);
    outline:none;
  }
  input:focus,textarea:focus,select:focus{ border-color:#364a74; }
  .btn{
    padding:10px 14px; border-radius:10px;
    border:1px solid var(--border); background:#0f1625; color:#fff;
    cursor:pointer;
  }
  .btn.primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#0b0e13; border:none; font-weight:800; }
  .btn.danger{ background: #2a0f15; border-color:#501b24; color:#ffb4bd; }
  .btn.ghost{ background:#0e1423 }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; }

  /* Hide blue highlight on Android */
  a, button, input, select, textarea { -webkit-tap-highlight-color: transparent; }

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#0e1624; border:1px solid #25314b; color:#cfe1ff;
    padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); display:none; z-index:80;
  }
  .toast.show{ display:block }

  /* Image manager */
  .imgmgr{ border:1px dashed #2a3550; padding:10px; border-radius:12px; background:#0c1322; }
  .imgmgr .rowline{ display:flex; gap:8px; margin-bottom:8px; }
  .imgmgr input.url{ flex:1; }
  .thumbs{ display:flex; flex-wrap:wrap; gap:10px; }
  .thumb{
    position:relative; width:76px; height:76px; border-radius:10px; overflow:hidden;
    border:1px solid #243049; background:#0f1625;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .thumb .ctrls{ position:absolute; inset:auto 4px 4px 4px; display:flex; gap:4px; justify-content:space-between; }
  .thumb button{
    border:none; background:rgba(10,15,25,.7); color:#cfe1ff; padding:4px 6px; border-radius:8px; font-size:12px; cursor:pointer;
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">Precioussly</div>
    <button class="emoji-btn" id="settingsBtn" title="Settings">ðŸ˜Ž</button>
  </div>

  <div id="tabs" class="tabs" style="display:none;"></div>

  <div id="list" class="list"></div>

  <button class="fab" id="addBtn" title="Add item">ï¼‹</button>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="sheet">
      <h3 style="margin:6px 4px 10px">Connect Google Sheet</h3>
      <div class="row">
        <div>
          <label>Google Sheet Link</label>
          <input id="sheetLink" placeholder="Paste Google Sheet URL here">
        </div>
      </div>
      <div class="row two">
        <div>
          <label>Add Tab Name</label>
          <div style="display:flex; gap:8px;">
            <input id="tabName" placeholder="e.g. Sheet1">
            <button class="btn" id="addTabBtn">Add</button>
          </div>
        </div>
        <div>
          <label>Active Tab</label>
          <select id="activeTabSelect"></select>
        </div>
      </div>

      <div class="actions" style="margin-top:8px">
        <button class="btn primary" id="fetchBtn">Fetch from Active Tab</button>
        <button class="btn ghost" id="demoBtn">Load Demo Data</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--border); margin:14px 0">

      <details>
        <summary class="sub" style="cursor:pointer">Optional: Enable editing back to Google Sheets (needs API Key & OAuth Client ID)</summary>
        <div class="row two" style="margin-top:8px">
          <div>
            <label>Google API Key</label>
            <input id="apiKey" placeholder="AIza...">
          </div>
          <div>
            <label>OAuth Client ID</label>
            <input id="clientId" placeholder="xxxx.apps.googleusercontent.com">
          </div>
        </div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" id="signinBtn">Sign in (enable save)</button>
          <button class="btn danger" id="signoutBtn">Sign out</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="sheet">
      <h3 id="editTitleText" style="margin:6px 4px 10px">Edit Item</h3>
      <div id="editFields" class="row"></div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="saveItemBtn">Save Changes</button>
        <button class="btn danger" id="deleteItemBtn">Delete</button>
        <button class="btn" id="cancelEditBtn">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
(() => {
  /* ========= You do NOT hardcode any sheet links here ========= */
  /* The app asks you ONCE to choose an "Index Sheet" from Drive.  */
  /* That sheet has rows: Name | SheetURL | Tab                    */
  /* ============================================================= */

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const state = {
    // Saved in localStorage after first pick:
    indexSheetId: localStorage.getItem("preci.indexSheetId") || "",
    indexTabGuessList: ["Sheet1", "Index", "Sheets"],

    // Current dataset (the sheet you selected from menu)
    sheetId: "",
    activeTab: "Sheet1",
    headers: [],
    rows: [],
    sectionFilter: "All",

    // Google credentials (already used in your old file)
    apiKey: "AIzaSyCnzxctSVV_-bKRGox0tgGo2M_ajPONzbE",
    clientId: "746848628668-30i7srbj2o3ft2duikoeno9a6b98aadi.apps.googleusercontent.com",
    authEnabled: false,
    tokenClient: null,

    // Auto refresh
    refreshSeconds: 30,
    _refreshTimer: null,

    // Memory of all available datasets (from Index)
    datasets: [] // [{name, sheetId, tab}]
  };

  /* ------------------ Tiny helpers ------------------ */
  const toast = (msg) => {
    const t = $("#toast"); if(!t) return;
    t.textContent = msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  };
  const parseSheetId = (link) => {
    try {
      const m = String(link).match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return m ? m[1] : "";
    } catch(e){ return ""; }
  };
  const escapeHtml = (s) => String(s==null?"":s)
    .replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

  /* ------------------ Google APIs ------------------ */
  async function initGapi(){
    if(!window.gapi) return;
    await new Promise(resolve => gapi.load('client', resolve));
    await gapi.client.init({
      apiKey: state.apiKey,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    });
  }
  function initGis(){
    if(!window.google || !google.accounts) return;
    state.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: state.clientId,
      scope: "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly",
      callback: (resp) => {
        if(resp.error){ toast("Sign in failed"); }
        else { state.authEnabled = true; toast("Google connected"); }
      }
    });
  }
  async function signIn(){
    await initGapi(); initGis();
    if(state.tokenClient){
      state.tokenClient.requestAccessToken({ prompt: "consent" });
    }
  }

  /* ------------------ GViz read (no auth if public) ------------------ */
  async function fetchGVizByTab(sheetId, tab){
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("fetch failed");
    const txt = await res.text();
    const json = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
    const obj = JSON.parse(json);
    const headers = (obj.table.cols||[]).map(c => (c.label||"").trim() || (c.id||""));
    const rows = (obj.table.rows||[]).map(r => (r.c||[]).map(cell => cell ? cell.v : ""));
    return { headers, rows };
  }

  async function fetchIndexSheet(){
    // Try common tab names to avoid you hardcoding anything
    for(const tab of state.indexTabGuessList){
      try{
        const { headers, rows } = await fetchGVizByTab(state.indexSheetId, tab);
        if(headers.length){
          const idxName  = headers.findIndex(h => /^name$/i.test(h));
          const idxUrl   = headers.findIndex(h => /^sheet\s*url$/i.test(h));
          const idxTab   = headers.findIndex(h => /^tab$/i.test(h));
          if(idxName===-1 || idxUrl===-1){ continue; }

          const ds = [];
          rows.forEach(r=>{
            const name = r[idxName] || "Untitled";
            const url  = r[idxUrl]  || "";
            const tabv = idxTab>-1 ? (r[idxTab] || "Sheet1") : "Sheet1";
            const sid  = parseSheetId(url);
            if(sid) ds.push({ name, sheetId: sid, tab: tabv });
          });
          if(ds.length){ return ds; }
        }
      }catch(e){ /* try next */ }
    }
    throw new Error("Index tab not found. Use tab name: Sheet1 / Index / Sheets");
  }

  /* ------------------ Drive Picker (choose Index once) ------------------ */
  function openPickerForIndex(){
    // Load Picker library:
    gapi.load('picker', () => {
      const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
        .setIncludeFolders(true)
        .setSelectFolderEnabled(false);
      const picker = new google.picker.PickerBuilder()
        .setDeveloperKey(state.apiKey)
        .setAppId("") // optional
        .setOAuthToken(gapi.client.getToken()?.access_token || "")
        .addView(view)
        .setTitle("Choose your INDEX SHEET (contains Name | SheetURL | Tab)")
        .setCallback(async data => {
          if(data.action === google.picker.Action.PICKED){
            const doc = data.docs && data.docs[0];
            if(doc && doc.id){
              state.indexSheetId = doc.id;
              localStorage.setItem("preci.indexSheetId", state.indexSheetId);
              toast("Index selected");
              await loadIndexAndRender();
            }
          }
        })
        .build();
      picker.setVisible(true);
    });
  }

  /* ------------------ UI: Menu of datasets + Sections ------------------ */
  function renderDatasetsMenu(){
    const wrap = $("#tabs");
    wrap.innerHTML = "";
    const left = document.createElement("div");
    left.style.display="flex"; left.style.flexWrap="wrap"; left.style.gap="8px";

    // Dataset chips
    state.datasets.forEach(ds => {
      const chip = document.createElement("div");
      chip.className = "tab-chip" + (ds.sheetId===state.sheetId && ds.tab===state.activeTab ? " active":"");
      chip.textContent = ds.name;
      chip.onclick = async () => {
        state.sheetId = ds.sheetId;
        state.activeTab = ds.tab || "Sheet1";
        await fetchCurrentDataset();
      };
      left.appendChild(chip);
    });

    // Right controls
    const right = document.createElement("div");
    right.style.marginLeft="auto"; right.style.display="flex"; right.style.gap="8px";

    const btnSwitch = document.createElement("button");
    btnSwitch.className = "btn ghost";
    btnSwitch.textContent = "Switch Index";
    btnSwitch.onclick = async ()=>{
      if(!state.authEnabled) await signIn();
      openPickerForIndex();
    };

    const btnReload = document.createElement("button");
    btnReload.className = "btn ghost";
    btnReload.textContent = "Reload";
    btnReload.onclick = fetchCurrentDataset;

    right.appendChild(btnSwitch);
    right.appendChild(btnReload);

    wrap.appendChild(left);
    wrap.appendChild(right);
  }

  function renderSectionsMenu(){
    // Appends below dataset chips
    const wrap = $("#tabs");
    const hr = document.createElement("div");
    hr.style.flexBasis="100%"; hr.style.height="0";
    wrap.appendChild(hr);

    const sectionsBar = document.createElement("div");
    sectionsBar.style.display="flex"; sectionsBar.style.flexWrap="wrap"; sectionsBar.style.gap="8px";

    const sectionKey = state.headers.find(h => /section/i.test(h));
    const sections = new Set(["All"]);
    if(sectionKey){
      state.rows.forEach(r => {
        const v = (r[sectionKey]||"").toString().trim();
        if(v) sections.add(v);
      });
    }
    sections.forEach(sec=>{
      const chip = document.createElement("div");
      chip.className = "tab-chip" + (sec===state.sectionFilter? " active":"");
      chip.textContent = sec;
      chip.onclick = ()=>{ state.sectionFilter = sec; renderList(); };
      sectionsBar.appendChild(chip);
    });

    wrap.appendChild(sectionsBar);
  }

  /* ------------------ Cards / Editor (same UX) ------------------ */
  function getThumb(row){
    const photoKeys = Object.keys(row)
      .filter(k => /photo\s*\d+/i.test(k))
      .sort((a,b)=> (parseInt(a.replace(/\D+/g,''))||0) - (parseInt(b.replace(/\D+/g,''))||0));
    for(const k of photoKeys){ if(row[k]) return row[k]; }
    const single = Object.keys(row).find(k => /image/i.test(k));
    if(single){
      const parts = String(row[single]||"").split(/[, \n]+/).filter(Boolean);
      if(parts[0]) return parts[0];
    }
    return "";
  }

  function renderList(){
    const list = $("#list");
    list.innerHTML = "";

    if(!state.rows.length){
      const empty = document.createElement("div");
      empty.style.cssText="text-align:center;color:var(--muted);padding:24px";
      empty.textContent = state.sheetId ? "No rows in this sheet." : "Choose your Index Sheet to begin.";
      list.appendChild(empty);
      return;
    }

    const titleKey   = state.headers.find(h => /product\s*name/i.test(h)) || state.headers[0];
    const sectionKey = state.headers.find(h => /section/i.test(h)) || state.headers[1];
    const badgeKey   = state.headers.find(h => /badge/i.test(h));
    const visKey     = state.headers.find(h => /visibil/i.test(h));
    const mrpKey     = state.headers.find(h => /mrp/i.test(h));
    const spKey      = state.headers.find(h => /selling\s*price/i.test(h));

    const filtered = state.sectionFilter==="All" || !sectionKey
      ? state.rows
      : state.rows.filter(r => (r[sectionKey]||"") === state.sectionFilter);

    filtered.forEach((row) => {
      const idx = state.rows.indexOf(row);
      const card = document.createElement("div"); card.className = "card"; card.dataset.index = idx;

      const thumb = document.createElement("div"); thumb.className = "thumb-mini";
      const img = document.createElement("img"); img.src = getThumb(row) || "data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect fill='%23131a2a' width='100%' height='100%'/></svg>";
      thumb.appendChild(img);

      const mid = document.createElement("div"); mid.style.flex="1";
      mid.innerHTML = `<h4>${escapeHtml(row[titleKey]||"Untitled")}</h4>
                       <div class="sub">${escapeHtml(row[sectionKey]||"")}</div>`;
      const chips = document.createElement("div"); chips.className = "chips";
      if(badgeKey && row[badgeKey]){
        const chip = document.createElement("span"); chip.className="chip badge"; chip.textContent = row[badgeKey];
        chips.appendChild(chip);
      }
      if(visKey && String(row[visKey]).toLowerCase().includes("hide")){
        const chip = document.createElement("span"); chip.className="chip hide"; chip.textContent = "Hidden";
        chips.appendChild(chip);
      }
      mid.appendChild(chips);

      const right = document.createElement("div"); right.className = "rightbox";
      const price = document.createElement("div"); price.className="price";
      if(spKey && row[spKey]){
        price.innerHTML = `<span class="sell">â‚¹${escapeHtml(row[spKey])}</span>`;
        if(mrpKey && row[mrpKey]) price.innerHTML += `<span class="mrp">MRP â‚¹${escapeHtml(row[mrpKey])}</span>`;
      }
      const openBtn = document.createElement("button"); openBtn.className="open-btn"; openBtn.textContent="Open";
      openBtn.onclick = (e)=>{ e.stopPropagation(); openEditor(idx); };

      right.appendChild(price); right.appendChild(openBtn);

      card.onclick = ()=> openEditor(idx);
      card.appendChild(thumb); card.appendChild(mid); card.appendChild(right);
      list.appendChild(card);
    });
  }

  /* ---------- Editor + Writeback (per-row) ---------- */
  function parseImages(str){ return !str ? [] : String(str).split(/[\n,]+/).map(s=>s.trim()).filter(Boolean); }
  function imagesToString(arr){ return arr.join(", "); }

  function buildImageManager(initial, onChange){
    const wrap = document.createElement("div"); wrap.className = "imgmgr";
    let imgs = [...initial];
    const rowline = document.createElement("div"); rowline.className="rowline";
    const urlInput = document.createElement("input"); urlInput.className="url"; urlInput.placeholder="Paste image URL and press Add";
    const addBtn = document.createElement("button"); addBtn.className="btn"; addBtn.textContent="Add";
    rowline.appendChild(urlInput); rowline.appendChild(addBtn);

    const thumbs = document.createElement("div"); thumbs.className="thumbs";
    const renderThumbs = () => {
      thumbs.innerHTML=""; imgs.forEach((u,i)=>{
        const th = document.createElement("div"); th.className="thumb";
        const img = document.createElement("img"); img.src=u;
        const ctrls = document.createElement("div"); ctrls.className="ctrls";
        const up=document.createElement("button"); up.textContent="â–²";
        const down=document.createElement("button"); down.textContent="â–¼";
        const del=document.createElement("button"); del.textContent="âœ•";
        up.onclick=()=>{ if(i>0){ const t=imgs[i-1]; imgs[i-1]=imgs[i]; imgs[i]=t; changed(); } };
        down.onclick=()=>{ if(i<imgs.length-1){ const t=imgs[i+1]; imgs[i+1]=imgs[i]; imgs[i]=t; changed(); } };
        del.onclick=()=>{ imgs.splice(i,1); changed(); };
        ctrls.appendChild(up); ctrls.appendChild(down); ctrls.appendChild(del);
        th.appendChild(img); th.appendChild(ctrls); thumbs.appendChild(th);
      });
    };
    const changed=()=>{ renderThumbs(); onChange(imgs); };
    addBtn.onclick=()=>{ const v=urlInput.value.trim(); if(!v) return; imgs.push(v); urlInput.value=""; changed(); };
    wrap.appendChild(rowline); wrap.appendChild(thumbs); renderThumbs();
    return { el: wrap, get: ()=>imgs.slice() };
  }

  async function ensureWriteAuth(){
    if(!state.authEnabled){ await signIn(); }
    if(!gapi.client.getToken()) await signIn();
  }

  async function writeRowToSheet(index){
    await ensureWriteAuth();
    const range = `${state.activeTab}!A${index+2}:${String.fromCharCode(65+state.headers.length-1)}${index+2}`;
    const values = [ state.headers.map(h => state.rows[index][h] ?? "") ];
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: state.sheetId, range, valueInputOption: "RAW",
      resource: { values }
    });
  }
  async function appendRowToSheet(rowObj){
    await ensureWriteAuth();
    const range = `${state.activeTab}!A2:${String.fromCharCode(65+state.headers.length-1)}`;
    const values = [ state.headers.map(h => rowObj[h] ?? "") ];
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: state.sheetId, range, valueInputOption: "RAW",
      insertDataOption: "INSERT_ROWS", resource: { values }
    });
  }
  async function writeAllRowsToSheet(){
    await ensureWriteAuth();
    const arr = state.rows.map(row => state.headers.map(h => row[h] ?? ""));
    const range = `${state.activeTab}!A2:${String.fromCharCode(65+state.headers.length-1)}`;
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: state.sheetId, range, valueInputOption: "RAW",
      resource: { values: arr }
    });
  }

  function openEditor(index){
    const isNew = (index === -1);
    $("#editTitleText").textContent = isNew ? "Add Item" : "Edit Item";
    const fieldsWrap = $("#editFields"); fieldsWrap.innerHTML = "";
    const row = isNew ? Object.fromEntries(state.headers.map(h=>[h,""])) : {...state.rows[index]};

    // Build fields
    const photoFields = state.headers.filter(h => /photo\s*\d+/i.test(h))
      .sort((a,b)=> (parseInt(a.replace(/\D+/g,''))||0) - (parseInt(b.replace(/\D+/g,''))||0));

    const handled = new Set();
    if(photoFields.length){
      const lbl = document.createElement("label"); lbl.textContent = "Photos (multiple URLs)";
      const mgr = buildImageManager(photoFields.map(h=>row[h]).filter(Boolean), ()=>{});
      const box = document.createElement("div"); box.appendChild(lbl); box.appendChild(mgr.el);
      fieldsWrap.appendChild(box);
      fieldsWrap._photoMgrGet = mgr.get; fieldsWrap._photoFields = photoFields;
      handled.add("photos-block");
    }

    state.headers.forEach(h => {
      if(photoFields.includes(h)) return;
      if(/image/i.test(h) && !/photo/i.test(h)){
        const lbl = document.createElement("label"); lbl.textContent = h + " (multiple URLs)";
        const mgr = buildImageManager(parseImages(row[h]||""), arr => { row[h] = arr.join(", "); });
        const box = document.createElement("div"); box.appendChild(lbl); box.appendChild(mgr.el);
        fieldsWrap.appendChild(box);
      } else {
        const f = document.createElement("div");
        f.innerHTML = `<label>${escapeHtml(h)}</label><input data-key="${escapeHtml(h)}" value="${escapeHtml(row[h] ?? "")}">`;
        fieldsWrap.appendChild(f);
      }
    });

    $("#editModal").classList.add("show");
    $("#saveItemBtn").onclick = async () => {
      Array.from(fieldsWrap.querySelectorAll("input[data-key]")).forEach(i => row[i.dataset.key] = i.value);
      if(fieldsWrap._photoMgrGet){
        const arr = fieldsWrap._photoMgrGet();
        const pfields = fieldsWrap._photoFields;
        for(let i=0;i<pfields.length;i++) row[pfields[i]] = arr[i] || "";
      }
      if(isNew){
        state.rows.push(row);
        try{ await appendRowToSheet(row); toast("Added to Sheet"); } catch(e){ toast("Add failed"); }
      }else{
        state.rows[index] = row;
        try{ await writeRowToSheet(index); toast("Saved to Sheet"); } catch(e){ toast("Save failed"); }
      }
      renderList(); $("#editModal").classList.remove("show");
    };
    $("#deleteItemBtn").onclick = async () => {
      if(!confirm("Delete this item?")) return;
      state.rows.splice(index,1);
      try{ await writeAllRowsToSheet(); toast("Deleted in Sheet"); } catch(e){ toast("Delete failed"); }
      renderList(); $("#editModal").classList.remove("show");
    };
    $("#cancelEditBtn").onclick = () => $("#editModal").classList.remove("show");
  }

  /* ------------------ Loaders ------------------ */
  async function fetchCurrentDataset(){
    if(!state.sheetId || !state.activeTab) return;
    try{
      const { headers, rows } = await fetchGVizByTab(state.sheetId, state.activeTab);
      state.headers = headers;
      state.rows = rows.map(r => {
        const obj = {}; headers.forEach((h,i)=> obj[h] = r[i] ?? ""); return obj;
      });
      $("#tabs").innerHTML = "";
      renderDatasetsMenu();
      renderSectionsMenu();
      renderList();
    }catch(e){
      toast("Read failed (private?). Sign in and try again.");
    }
  }

  async function loadIndexAndRender(){
    try{
      state.datasets = await fetchIndexSheet();
      if(!state.datasets.length){ toast("Index empty"); renderList(); return; }
      // Default: first dataset selected
      state.sheetId  = state.datasets[0].sheetId;
      state.activeTab = state.datasets[0].tab || "Sheet1";
      renderDatasetsMenu();
      await fetchCurrentDataset();
      startAutoRefresh();
    }catch(e){
      toast("Index not readable. Use Switch Index and pick the right sheet.");
      renderList();
    }
  }

  function startAutoRefresh(){
    if(state._refreshTimer) clearInterval(state._refreshTimer);
    if(state.refreshSeconds>0){
      state._refreshTimer = setInterval(fetchCurrentDataset, state.refreshSeconds*1000);
    }
  }

  /* ------------------ Boot ------------------ */
  function askForIndexIfNeeded(){
    if(state.indexSheetId) return false;
    // Show minimal banner in the list area:
    const list = $("#list"); list.innerHTML = "";
    const box = document.createElement("div");
    box.style.cssText="text-align:center;color:var(--muted);padding:24px";
    box.innerHTML = `
      <div style="font-size:16px;margin-bottom:10px;">Choose your <b>Index Sheet</b> (contains <i>Name | SheetURL | Tab</i>)</div>
      <button class="btn primary" id="chooseIndexBtn">Pick from Google Drive</button>
    `;
    list.appendChild(box);
    $("#chooseIndexBtn").onclick = async ()=>{
      if(!state.authEnabled) await signIn();
      openPickerForIndex();
    };
    return true;
  }

  async function boot(){
    renderList(); // initial state
    if(!askForIndexIfNeeded()){
      // We already have index sheet stored
      await loadIndexAndRender();
    }
    // Plus â€œAddâ€ button behaviour stays the same:
    $("#addBtn")?.addEventListener("click", () => {
      if(!state.headers.length){ toast("Open a dataset first."); return; }
      openEditor(-1);
    });

    // Close modals by tapping outside
    $$(".modal").forEach(m => m.addEventListener("click",(e)=>{
      if(e.target.classList.contains("modal")) e.target.classList.remove("show");
    }));
  }

  boot();
})();
</script>
</body>
</html>
