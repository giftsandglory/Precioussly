<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Precioussly â€” Fixed</title>
<style>
  :root{
    --bg:#0b0e13;
    --surface:#141824;
    --surface-2:#1a2030;
    --text:#e8ecf3;
    --muted:#9aa4b2;
    --brand:#67b3ff;
    --brand-2:#8b7bff;
    --accent:#22c55e;
    --danger:#ff5d6c;
    --border:rgba(255,255,255,0.08);
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 50% -200px, #1c2541 0%, #0b0e13 60%);
    color:var(--text);
    font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-font-smoothing:antialiased;
    -webkit-tap-highlight-color: transparent;
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:center;
    padding:8px 12px;
    background:linear-gradient(180deg, rgba(10,13,20,.95), rgba(10,13,20,.75));
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .title{
    font-weight:800; letter-spacing:.2px;
    font-size:20px; background:linear-gradient(90deg,var(--brand),var(--brand-2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    margin:6px 0;
  }
  .emoji-btn{
    position:absolute; right:12px; top:8px;
    font-size:22px; line-height:1;
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 10px;
    box-shadow:var(--shadow);
    cursor:pointer; user-select:none;
    transform: translateZ(0);
  }
  .emoji-btn:active{ transform:scale(.98) }

  /* Tabs bar (sheet tabs) */
  .tabs{
    position:sticky; top:52px; z-index:40;
    display:flex; gap:8px; overflow:auto; padding:10px 12px 4px;
    background:linear-gradient(180deg, rgba(10,13,20,.85), rgba(10,13,20,0));
    scrollbar-width:none;
  }
  .tabs::-webkit-scrollbar{ display:none }
  .tab-chip{
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--surface);
    color:var(--muted);
    white-space:nowrap; cursor:pointer;
  }
  .tab-chip.active{ background:linear-gradient(90deg,#1f2840,#111728); color:var(--text); border-color:#2a3655 }

  /* List cards */
  .list{ padding:10px 10px 100px; }
  .card{
    background:linear-gradient(180deg,#121826,#0f1422);
    border:1px solid var(--border);
    border-radius:16px;
    padding:10px 12px;
    margin:10px auto;
    max-width:820px;
    display:flex; gap:12px; align-items:center;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
    transition:transform .12s ease, background .2s ease;
    touch-action: manipulation;
  }
  .thumb-mini{
    flex:0 0 68px; height:68px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#0f1625;
  }
  .thumb-mini img{ width:100%; height:100%; object-fit:cover; display:block; }
  .card:hover{ transform: translateY(-1px); }
  .card h4{ margin:0 0 2px 0; font-size:16px; font-weight:800; color:#d7e6ff; }
  .sub{ color:var(--muted); font-size:12px; word-break:break-all; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border); background:#0e1525; color:#cfe1ff; }
  .chip.badge{ background:linear-gradient(135deg,#fceabb,#f8b500); color:#231b00; border:none; font-weight:800; }
  .chip.hide{ background:#26131a; color:#ffd7de; border-color:#5a1f2c; }
  .price{ text-align:right; margin-left:auto; flex:0 0 auto; }
  .price .sell{ font-weight:900; font-size:18px; color:#b4ffcb; }
  .price .mrp{ color:#97a1b3; text-decoration:line-through; font-size:12px; display:block; }
  .rightbox{
    display:flex; align-items:center; gap:10px;
    margin-left:auto; flex:0 0 auto;
  }
  .open-btn{
    padding:8px 14px; border-radius:10px;
    border:1px solid var(--border);
    background:#111827; color:#bcd0ff; font-weight:700; cursor:pointer;
    flex:0 0 auto;
  }

  /* Reorder controls (shown on long press) */
  .reorder{ display:none; gap:8px; }
  .rbtn{
    width:36px; height:36px; border-radius:999px;
    border:1px solid var(--border); background:#0f1625; color:#c7d2fe;
    display:grid; place-items:center; font-size:18px; cursor:pointer;
  }
  .card.reorder-mode .reorder{ display:flex; }
  .card.reorder-mode .open-btn{ display:none; }

  /* Floating add button */
  .fab{
    position:fixed; right:14px; bottom:16px; z-index:45;
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center;
    background:linear-gradient(135deg,var(--brand-2),var(--brand));
    color:#0b0e13; font-size:24px; font-weight:900;
    box-shadow:var(--shadow);
    border:none; cursor:pointer;
  }

  /* Modal base */
  .modal{
    position:fixed; inset:0; display:none; z-index:60;
    background:rgba(3,6,12,.6); backdrop-filter: blur(6px);
    align-items:center; justify-content:center; padding:20px;
  }
  .modal.show{ display:flex }
  .sheet{
    width:min(760px, 96vw);
    max-height:86vh; overflow:auto;
    background:linear-gradient(180deg,#121827,#0f1524);
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow:var(--shadow);
    animation:pop .2s ease;
  }
  @keyframes pop{ from{ opacity:0; transform: translateY(6px) scale(.98);} to{opacity:1; transform:none;} }

  .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .row.two{ grid-template-columns: 1fr 1fr; }
  label{ color:var(--muted); font-size:12px; }
  input,textarea,select{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid #243049; background:#0f1625; color:var(--text);
    outline:none;
  }
  input:focus,textarea:focus,select:focus{ border-color:#364a74; }
  .btn{
    padding:10px 14px; border-radius:10px;
    border:1px solid var(--border); background:#0f1625; color:#fff;
    cursor:pointer;
  }
  .btn.primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#0b0e13; border:none; font-weight:800; }
  .btn.danger{ background: #2a0f15; border-color:#501b24; color:#ffb4bd; }
  .btn.ghost{ background:#0e1423 }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; }

  a, button, input, select, textarea { -webkit-tap-highlight-color: transparent; }

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#0e1624; border:1px solid #25314b; color:#cfe1ff;
    padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); display:none; z-index:80;
  }
  .toast.show{ display:block }

  /* Image manager */
  .imgmgr{ border:1px dashed #2a3550; padding:10px; border-radius:12px; background:#0c1322; }
  .imgmgr .rowline{ display:flex; gap:8px; margin-bottom:8px; }
  .imgmgr input.url{ flex:1; }
  .thumbs{ display:flex; flex-wrap:wrap; gap:10px; }
  .thumb{
    position:relative; width:76px; height:76px; border-radius:10px; overflow:hidden;
    border:1px solid #243049; background:#0f1625;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .thumb .ctrls{ position:absolute; inset:auto 4px 4px 4px; display:flex; gap:4px; justify-content:space-between; }
  .thumb button{
    border:none; background:rgba(10,15,25,.7); color:#cfe1ff; padding:4px 6px; border-radius:8px; font-size:12px; cursor:pointer;
  }

  /* Small screens: keep button aligned to the right neatly */
  @media (max-width: 480px){
    .card{ gap:10px; }
    .rightbox{ gap:8px; }
    .open-btn{ padding:8px 12px; }
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">Precioussly</div>
    <button class="emoji-btn" id="settingsBtn" title="Settings">ðŸ˜Ž</button>
  </div>

  <div id="tabs" class="tabs" style="display:none;"></div>

  <div id="list" class="list"></div>

  <button class="fab" id="addBtn" title="Add item">ï¼‹</button>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="sheet">
      <h3 style="margin:6px 4px 10px">Connect Google Sheet</h3>
      <div class="row">
        <div>
          <label>Google Sheet Link</label>
          <input id="sheetLink" placeholder="Paste Google Sheet URL here">
        </div>
      </div>
      <div class="row two">
        <div>
          <label>Add Tab Name</label>
          <div style="display:flex; gap:8px;">
            <input id="tabName" placeholder="e.g. Sheet1">
            <button class="btn" id="addTabBtn">Add</button>
          </div>
        </div>
        <div>
          <label>Active Tab</label>
          <select id="activeTabSelect"></select>
        </div>
      </div>

      <div class="actions" style="margin-top:8px">
        <button class="btn primary" id="fetchBtn">Fetch from Active Tab</button>
        <button class="btn ghost" id="demoBtn">Load Demo Data</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--border); margin:14px 0">

      <details>
        <summary class="sub" style="cursor:pointer">Optional: Enable editing back to Google Sheets (needs API Key & OAuth Client ID)</summary>
        <div class="row two" style="margin-top:8px">
          <div>
            <label>Google API Key</label>
            <input id="apiKey" placeholder="AIza...">
          </div>
          <div>
            <label>OAuth Client ID</label>
            <input id="clientId" placeholder="xxxx.apps.googleusercontent.com">
          </div>
        </div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" id="signinBtn">Sign in (enable save)</button>
          <button class="btn danger" id="signoutBtn">Sign out</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="sheet">
      <h3 id="editTitleText" style="margin:6px 4px 10px">Edit Item</h3>
      <div id="editFields" class="row"></div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="saveItemBtn">Save Changes</button>
        <button class="btn danger" id="deleteItemBtn">Delete</button>
        <button class="btn" id="cancelEditBtn">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    sheetId: "",
    tabs: [],
    activeTab: "",
    headers: [],
    rows: [],
    apiKey: "AIzaSyCnzxctSVV_-bKRGox0tgGo2M_ajPONzbE",
    clientId: "746848628668-30i7srbj2o3ft2duikoeno9a6b98aadi.apps.googleusercontent.com",
    authEnabled: false,
    tokenClient: null
  };

  const toast = (msg) => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  };

  const parseSheetId = (link) => {
    if(!link) return "";
    // Accept full link or bare ID
    const idMatch = String(link).match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return idMatch ? idMatch[1] : String(link).trim();
  };

  const saveLocal = () => {
    localStorage.setItem("prec.sheet", JSON.stringify({
      sheetId: state.sheetId,
      tabs: state.tabs,
      activeTab: state.activeTab,
      apiKey: state.apiKey,
      clientId: state.clientId
    }));
  };
  const loadLocal = () => {
    try{
      const o = JSON.parse(localStorage.getItem("prec.sheet")||"{}");
      if(o.sheetId) state.sheetId = o.sheetId;
      if(o.tabs) state.tabs = o.tabs;
      if(o.activeTab) state.activeTab = o.activeTab;
      if(o.apiKey) state.apiKey = o.apiKey;
      if(o.clientId) state.clientId = o.clientId;
      renderSettingsFromState();
    }catch(e){}
  };

  /* ---------- Public fetch via GViz ---------- */
  async function fetchGViz(sheetId, tab){
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Fetch failed");
    const txt = await res.text();
    const jsonStr = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
    const obj = JSON.parse(jsonStr);
    const cols = (obj.table.cols||[]).map(c => (c.label||"").trim() || (c.id||""));
    const headers = cols.length ? cols : [];
    const rows = (obj.table.rows||[]).map(r => (r.c||[]).map(cell => cell ? cell.v : ""));
    return { headers, rows };
  }

  /* ---------- Google API auth & read/write ---------- */
  async function initGapi(){
    if(!window.gapi) return;
    await new Promise(resolve => gapi.load('client', resolve));
    await gapi.client.init({
      apiKey: state.apiKey,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    });
  }
  function initGis(){
    if(!window.google || !google.accounts) return;
    state.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: state.clientId,
      scope: "https://www.googleapis.com/auth/spreadsheets",
      callback: (resp) => {
        if(resp.error){
          toast("Sign in failed");
        }else{
          state.authEnabled = true; toast("Editing enabled");
        }
      }
    });
  }
  function signIn(){
    if(!state.clientId || !state.apiKey){ toast("Enter API Key & Client ID first"); return; }
    initGapi().then(()=>{
      initGis();
      if(state.tokenClient){
        state.tokenClient.requestAccessToken({ prompt: "consent" });
      }else{
        toast("GIS init failed");
      }
    });
  }
  function signOut(){
    const tok = gapi.client.getToken();
    if(tok){
      google.accounts.oauth2.revoke(tok.access_token);
      gapi.client.setToken('');
    }
    state.authEnabled = false;
    toast("Signed out");
  }

  async function writeRowToSheet(index){
    const range = `${state.activeTab}!A${index+2}:${String.fromCharCode(65+state.headers.length-1)}${index+2}`;
    const values = [ state.headers.map(h => state.rows[index][h] ?? "") ];
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: state.sheetId,
      range,
      valueInputOption: "RAW",
      resource: { values }
    });
  }
  async function appendRowToSheet(rowObj){
    const range = `${state.activeTab}!A2:${String.fromCharCode(65+state.headers.length-1)}`;
    const values = [ state.headers.map(h => rowObj[h] ?? "") ];
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: state.sheetId,
      range,
      valueInputOption: "RAW",
      insertDataOption: "INSERT_ROWS",
      resource: { values }
    });
  }
  async function writeAllRowsToSheet(){
    const arr = state.rows.map(row => state.headers.map(h => row[h] ?? ""));
    const range = `${state.activeTab}!A2:${String.fromCharCode(65+state.headers.length-1)}`;
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: state.sheetId,
      range,
      valueInputOption: "RAW",
      resource: { values: arr }
    });
  }

  /* ---------- Render ---------- */
  function renderTabs(){
    const tabsWrap = $("#tabs");
    tabsWrap.innerHTML = "";
    if(!state.tabs.length){ tabsWrap.style.display="none"; return; }
    tabsWrap.style.display = "flex";
    state.tabs.forEach(tab => {
      const el = document.createElement("div");
      el.className = "tab-chip" + (tab===state.activeTab? " active": "");
      el.textContent = tab;
      el.onclick = () => { state.activeTab = tab; saveLocal(); if(state.sheetId) fetchCurrent(); };
      tabsWrap.appendChild(el);
    });
  }

  function looksLikeImageUrl(v){
    if(!v) return "";
    let s = String(v).trim();
    // If Google Drive share link, convert to direct
    const drive = s.match(/drive\.google\.com\/file\/d\/([^/]+)/i);
    if(drive){ s = `https://drive.google.com/uc?export=view&id=${drive[1]}`; }
    // Accept direct image extensions or postimg CDN
    const m = s.match(/https?:\/\/[^\s)'"<]+?\.(?:png|jpe?g|webp|gif)(\?.*)?$/i) || s.match(/https?:\/\/i\.postimg\.cc\/[^\s)'"<]+/i);
    return m ? (drive ? s : m[0]) : "";
  }

  function getThumb(row){
    // 1) Explicit photo 1..N
    const p = Object.keys(row).filter(k => /photo\s*\d+/i.test(k)).sort((a,b)=>{
      const na = parseInt(a.replace(/\D+/g,''))||0, nb = parseInt(b.replace(/\D+/g,''))||0; return na-nb;
    });
    for(const k of p){ const u = looksLikeImageUrl(row[k]); if(u) return u; }
    // 2) Any header containing 'image'
    const ci = Object.keys(row).find(k => /image/i.test(k));
    if(ci){
      const parts = String(row[ci]||"").split(/[, \n]+/).filter(Boolean);
      for(const part of parts){ const u = looksLikeImageUrl(part); if(u) return u; }
    }
    // 3) Fallback: scan all cell values for first image-like URL
    for(const val of Object.values(row)){
      const u = looksLikeImageUrl(val);
      if(u) return u;
    }
    return "";
  }

  function renderList(){
    const list = $("#list");
    list.innerHTML = "";
    if(!state.rows.length){
      const empty = document.createElement("div");
      empty.style.cssText="text-align:center;color:var(--muted);padding:24px";
      empty.textContent = "No items yet. Tap ï¼‹ to add or use ðŸ˜Ž to connect a sheet.";
      list.appendChild(empty);
      return;
    }
    const titleKey = state.headers.find(h => /product\s*name/i.test(h)) || state.headers[0];
    const sectionKey = state.headers.find(h => /section|category/i.test(h)) || state.headers[1];
    const badgeKey = state.headers.find(h => /badge/i.test(h));
    const visKey = state.headers.find(h => /visibil/i.test(h));
    const mrpKey = state.headers.find(h => /mrp/i.test(h));
    const spKey = state.headers.find(h => /selling\s*price|sell(ing)?\s*price/i.test(h));

    state.rows.forEach((row, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.index = idx;

      const thumb = document.createElement("div");
      thumb.className = "thumb-mini";
      const timg = document.createElement("img");
      const tsrc = getThumb(row);
      if(tsrc){ timg.src = tsrc; } else { timg.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect fill='%23131a2a' x='0' y='0' width='100%' height='100%'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='10' fill='%23476'>No Image</text></svg>"; }
      timg.loading = "lazy";
      thumb.appendChild(timg);

      const mid = document.createElement("div");
      mid.style.flex="1";
      mid.innerHTML = `<h4>${escapeHtml(row[titleKey]||"Untitled")}</h4>
                       <div class="sub">${escapeHtml(row[sectionKey]||"")}</div>`;
      const chips = document.createElement("div"); chips.className = "chips";
      if(badgeKey && row[badgeKey]){
        const chip = document.createElement("span"); chip.className="chip badge"; chip.textContent = row[badgeKey];
        chips.appendChild(chip);
      }
      if(visKey && String(row[visKey]).toLowerCase().includes("hide")){
        const chip = document.createElement("span"); chip.className="chip hide"; chip.textContent = "Hidden";
        chips.appendChild(chip);
      }
      mid.appendChild(chips);

      const right = document.createElement("div"); right.className="rightbox";
      const price = document.createElement("div"); price.className="price";
      if(spKey && row[spKey]){
        price.innerHTML = `<span class="sell">â‚¹${escapeHtml(row[spKey])}</span>`;
        if(mrpKey && row[mrpKey]){
          price.innerHTML += `<span class="mrp">MRP â‚¹${escapeHtml(row[mrpKey])}</span>`;
        }
        right.appendChild(price);
      }

      const reorderWrap = document.createElement("div");
      reorderWrap.className="reorder";
      const up = document.createElement("button"); up.className="rbtn"; up.textContent="â–²";
      const down = document.createElement("button"); down.className="rbtn"; down.textContent="â–¼";
      up.onclick = (e)=>{ e.stopPropagation(); moveItem(idx, -1); };
      down.onclick = (e)=>{ e.stopPropagation(); moveItem(idx, 1); };
      reorderWrap.appendChild(up); reorderWrap.appendChild(down);

      const openBtn = document.createElement("button");
      openBtn.className = "open-btn"; openBtn.textContent = "Open";
      openBtn.onclick = (e)=>{ e.stopPropagation(); openEditor(idx); };

      right.appendChild(reorderWrap);
      right.appendChild(openBtn);

      let pressTimer;
      const start = () => { pressTimer = setTimeout(()=>{ card.classList.add("reorder-mode"); }, 400); };
      const cancel = () => { clearTimeout(pressTimer); };
      card.addEventListener("touchstart", start, {passive:true});
      card.addEventListener("touchend", cancel);
      card.addEventListener("touchmove", cancel);
      card.addEventListener("mousedown", start);
      card.addEventListener("mouseup", cancel);
      card.addEventListener("mouseleave", cancel);

      card.onclick = ()=> openEditor(idx);

      card.appendChild(thumb);
      card.appendChild(mid);
      card.appendChild(right);
      list.appendChild(card);
    });
  }

  function renderSettingsFromState(){
    $("#sheetLink").value = state.sheetId ? `https://docs.google.com/spreadsheets/d/${state.sheetId}/edit` : "";
    $("#apiKey").value = state.apiKey || "";
    $("#clientId").value = state.clientId || "";
    const select = $("#activeTabSelect");
    select.innerHTML = "";
    state.tabs.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t; opt.textContent = t;
      if(t===state.activeTab) opt.selected = true;
      select.appendChild(opt);
    });
    renderTabs();
  }

  function openSettings(){ $("#settingsModal").classList.add("show"); }
  function closeSettings(){ $("#settingsModal").classList.remove("show"); }

  /* -------- Image Manager helpers -------- */
  function parseImages(str){
    if(!str) return [];
    return String(str).split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  }
  function imagesToString(arr){ return arr.join(", "); }
  function buildImageManager(initial, onChange){
    const wrap = document.createElement("div");
    wrap.className = "imgmgr";
    let imgs = [...initial];

    const rowline = document.createElement("div");
    rowline.className = "rowline";
    const urlInput = document.createElement("input");
    urlInput.className = "url";
    urlInput.placeholder = "Paste image URL and press Add";
    const addBtn = document.createElement("button");
    addBtn.className = "btn";
    addBtn.textContent = "Add";
    rowline.appendChild(urlInput); rowline.appendChild(addBtn);

    const thumbs = document.createElement("div");
    thumbs.className = "thumbs";

    function renderThumbs(){
      thumbs.innerHTML = "";
      imgs.forEach((u, i) => {
        const th = document.createElement("div");
        th.className = "thumb";
        const img = document.createElement("img");
        img.src = u; img.alt = "img"; img.loading="lazy";
        const ctrls = document.createElement("div");
        ctrls.className = "ctrls";
        const up = document.createElement("button"); up.textContent = "â–²";
        const down = document.createElement("button"); down.textContent = "â–¼";
        const del = document.createElement("button"); del.textContent = "âœ•";
        up.onclick = () => { if(i>0){ const t=imgs[i-1]; imgs[i-1]=imgs[i]; imgs[i]=t; changed(); } };
        down.onclick = () => { if(i<imgs.length-1){ const t=imgs[i+1]; imgs[i+1]=imgs[i]; imgs[i]=t; changed(); } };
        del.onclick = () => { imgs.splice(i,1); changed(); };
        ctrls.appendChild(up); ctrls.appendChild(down); ctrls.appendChild(del);
        th.appendChild(img); th.appendChild(ctrls);
        thumbs.appendChild(th);
      });
    }
    function changed(){ renderThumbs(); onChange(imgs); }

    addBtn.onclick = () => {
      const v = urlInput.value.trim();
      if(!v) return;
      imgs.push(v); urlInput.value=""; changed();
    };

    wrap.appendChild(rowline);
    wrap.appendChild(thumbs);
    renderThumbs();
    return {el: wrap, get: ()=>imgs.slice(), set: (arr)=>{ imgs = arr.slice(); renderThumbs(); } };
  }

  function openEditor(index){
    const isNew = (index === -1);
    $("#editTitleText").textContent = isNew ? "Add Item" : "Edit Item";
    const fieldsWrap = $("#editFields");
    fieldsWrap.innerHTML = "";
    const row = isNew ? Object.fromEntries(state.headers.map(h=>[h,""])) : {...state.rows[index]};

    // Group photo fields
    const photoFields = state.headers.filter(h => /photo\s*\d+/i.test(h)).sort((a,b)=>{
      const na = parseInt(a.replace(/\D+/g,''))||0, nb = parseInt(b.replace(/\D+/g,''))||0; return na-nb;
    });
    const handled = new Set();

    if(photoFields.length){
      const lbl = document.createElement("label"); lbl.textContent = "Photos (supports multiple URLs)";
      const initial = photoFields.map(h => row[h]).filter(Boolean);
      const mgr = buildImageManager(initial, (arr)=>{ /* live preview only; apply on save */ });
      const box = document.createElement("div"); box.appendChild(lbl); box.appendChild(mgr.el);
      fieldsWrap.appendChild(box);
      fieldsWrap.dataset.photoManager = "1";
      fieldsWrap._photoMgrGet = mgr.get;
      fieldsWrap._photoFields = photoFields;
      photoFields.forEach(h => handled.add(h));
    }

    // Build remaining fields
    state.headers.forEach(h => {
      if(handled.has(h)) return;
      if(/image/i.test(h) && !/photo/i.test(h)){
        const lbl = document.createElement("label"); lbl.textContent = h + " (supports multiple URLs)";
        const mgr = buildImageManager(parseImages(row[h]||""), (arr)=>{ row[h] = imagesToString(arr); });
        const box = document.createElement("div"); box.appendChild(lbl); box.appendChild(mgr.el);
        fieldsWrap.appendChild(box);
      }else{
        const f = document.createElement("div");
        f.innerHTML = `<label>${escapeHtml(h)}</label><input data-key="${escapeHtml(h)}" value="${escapeHtml(row[h] ?? "")}">";
        fieldsWrap.appendChild(f);
      }
    });

    $("#editModal").classList.add("show");

    $("#saveItemBtn").onclick = async () => {
      Array.from(fieldsWrap.querySelectorAll("input[data-key]")).forEach(i => row[i.dataset.key] = i.value);
      if(fieldsWrap.dataset.photoManager === "1"){
        const arr = fieldsWrap._photoMgrGet();
        const pfields = fieldsWrap._photoFields;
        for(let i=0;i<pfields.length;i++){
          row[pfields[i]] = arr[i] || "";
        }
      }

      if(isNew){
        state.rows.push(row);
        if(state.authEnabled){
          try{ await appendRowToSheet(row); toast("Added to Sheet"); }
          catch(e){ toast("Add failed (check auth)"); }
        }else{
          toast("Added (local only)");
        }
      }else{
        state.rows[index] = row;
        if(state.authEnabled){
          try{ await writeRowToSheet(index); toast("Saved to Sheet"); }
          catch(e){ toast("Save failed (check auth)"); }
        }else{
          toast("Saved (local only)");
        }
      }
      renderList(); closeEditor();
    };
    $("#deleteItemBtn").onclick = async () => {
      if(!confirm("Delete this item?")) return;
      state.rows.splice(index,1);
      if(state.authEnabled){
        try{ await writeAllRowsToSheet(); toast("Deleted in Sheet"); }
        catch(e){ toast("Delete failed (check auth)"); }
      }else{
        toast("Deleted (local only)");
      }
      renderList(); closeEditor();
    };
    $("#cancelEditBtn").onclick = closeEditor;
  }
  function closeEditor(){ $("#editModal").classList.remove("show"); }

  function moveItem(index, dir){
    const newIdx = index + dir;
    if(newIdx<0 || newIdx>=state.rows.length) return;
    const item = state.rows.splice(index,1)[0];
    state.rows.splice(newIdx,0,item);
    renderList();
    if(state.authEnabled){
      writeAllRowsToSheet().then(()=>toast("Reordered")).catch(()=>toast("Reorder failed (auth?)"));
    }else{
      toast("Reordered (local only)");
    }
  }

  function escapeHtml(s){
    return String(s==null?"":s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }

  async function fetchCurrent(){
    if(!state.sheetId || !state.activeTab){ toast("Add sheet link & tab first"); return; }
    try{
      const { headers, rows } = await fetchGViz(state.sheetId, state.activeTab);
      if(!headers.length){
        toast("No headings found (maybe private). Try Sign in.");
        return;
      }
      state.headers = headers;
      state.rows = rows.map(r => {
        const obj = {};
        headers.forEach((h,i)=> obj[h] = r[i] ?? "");
        return obj;
      });
      renderList();
      toast(`Loaded ${state.rows.length} rows from ${state.activeTab}`);
    }catch(e){
      toast("Fetch failed. If sheet is private, enable editing and Sign in.");
    }
  }

  /* ---------- Event bindings ---------- */
  $("#settingsBtn").onclick = () => { openSettings(); };
  $("#fetchBtn").onclick = async () => {
    const id = parseSheetId($("#sheetLink").value.trim());
    if(!id) return toast("Invalid sheet link");
    state.sheetId = id;
    const activeSel = $("#activeTabSelect");
    state.activeTab = activeSel.value || state.tabs[0] || "Sheet1";
    saveLocal(); renderTabs(); closeSettings();
    fetchCurrent();
  };
  $("#addTabBtn").onclick = () => {
    const name = $("#tabName").value.trim();
    if(!name) return;
    if(!state.tabs.includes(name)) state.tabs.push(name);
    if(!state.activeTab) state.activeTab = name;
    $("#tabName").value = "";
    saveLocal(); renderSettingsFromState(); renderTabs();
  };
  $("#activeTabSelect").onchange = (e)=>{ state.activeTab = e.target.value; saveLocal(); };
  $("#demoBtn").onclick = ()=>{
    state.headers = ["Box Direction","Section","Product Name","visibility","Description","Badge","Category Image","photo 1","photo 2","photo 3","MRP","Selling Price","in stock"];
    state.rows = [
      {"Section":"Car Keychains","Product Name":"car Keychain","Badge":"Bestseller","Category Image":"https://i.postimg.cc/fk4627NT/IMG-20250629-004309.jpg","MRP":"80","Selling Price":"75"},
      {"Section":"Colors","Product Name":"Red","visibility":"hide","Category Image":"https://i.postimg.cc/zGjDws8k/IMG-20250817-WA0028.jpg","MRP":"15","Selling Price":"10"}
    ];
    renderList(); closeSettings(); toast("Premium demo loaded");
  };

  $("#addBtn").onclick = ()=>{
    if(!state.headers.length){
      state.headers = ["Box Direction","Section","Product Name","visibility","Description","Badge","photo 1","photo 2","photo 3","photo 4","MRP","Selling Price","in stock","google sheet","tab name"];
    }
    openEditor(-1);
  };

  $("#signinBtn").onclick = () => {
    state.apiKey = $("#apiKey").value.trim();
    state.clientId = $("#clientId").value.trim();
    saveLocal();
    signIn();
  };
  $("#signoutBtn").onclick = () => { signOut(); };

  $$(".modal").forEach(m => m.addEventListener("click",(e)=>{
    if(e.target.classList.contains("modal")) e.target.classList.remove("show");
  }));

  // ---------- AUTO-LOAD: no manual paste needed ----------
  // 1) Restore saved config
  loadLocal();

  // 2) Allow ?sheet=<link or id>&tab=Sheet1
  const params = new URLSearchParams(location.search);
  const qSheet = params.get("sheet") || params.get("id");
  const qTab = params.get("tab");
  if(qSheet){
    state.sheetId = parseSheetId(qSheet);
    if(qTab) state.activeTab = qTab;
    saveLocal();
  }
  // If still not set, choose a safe default tab
  if(!state.activeTab) state.activeTab = "Sheet1";

  // 3) Auto-fetch if we have a sheet id
  if(state.sheetId){
    fetchCurrent();
  } else {
    renderList(); // keep UI ready
  }
})();
</script>
</body>
</html>